<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics</title>
  <meta name="description" content="A technical manual of graphs, networks and their applications in the people and social sciences" />
  <meta name="generator" content="bookdown 0.22.15 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://ona-book.org" />
  <meta property="og:image" content="https://ona-book.org/www/cover/cover-ona.png" />
  <meta property="og:description" content="A technical manual of graphs, networks and their applications in the people and social sciences" />
  <meta name="github-repo" content="keithmcnulty/ona_book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Restructuring Data For Use in Graphs | Handbook of Graphs and Networks in People Analytics" />
  <meta name="twitter:site" content="@dr_keithmcnulty" />
  <meta name="twitter:description" content="A technical manual of graphs, networks and their applications in the people and social sciences" />
  <meta name="twitter:image" content="https://ona-book.org/www/cover/cover-ona.png" />

<meta name="author" content="Keith McNulty" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="viz-graphs.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.9.5/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<script src="libs/forceNetwork-binding-0.4/forceNetwork.js"></script>
<script src="libs/sankey-1/sankey.js"></script>
<script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Handbook of Regression Modeling in People Analytics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="everywhere.html"><a href="everywhere.html"><i class="fa fa-check"></i><b>1</b> Graphs everywhere!</a>
<ul>
<li class="chapter" data-level="1.1" data-path="everywhere.html"><a href="everywhere.html#graphs-as-mathematical-models"><i class="fa fa-check"></i><b>1.1</b> Graphs as mathematical models</a></li>
<li class="chapter" data-level="1.2" data-path="everywhere.html"><a href="everywhere.html#graph-theory-in-the-analysis-of-people-and-groups"><i class="fa fa-check"></i><b>1.2</b> Graph theory in the analysis of people and groups</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="everywhere.html"><a href="everywhere.html#the-study-of-connection"><i class="fa fa-check"></i><b>1.2.1</b> The study of connection</a></li>
<li class="chapter" data-level="1.2.2" data-path="everywhere.html"><a href="everywhere.html#the-study-of-information-flow"><i class="fa fa-check"></i><b>1.2.2</b> The study of information flow</a></li>
<li class="chapter" data-level="1.2.3" data-path="everywhere.html"><a href="everywhere.html#the-study-of-community-diversity-and-familiarity"><i class="fa fa-check"></i><b>1.2.3</b> The study of community, diversity and familiarity</a></li>
<li class="chapter" data-level="1.2.4" data-path="everywhere.html"><a href="everywhere.html#the-study-of-importance-influence-and-attachment"><i class="fa fa-check"></i><b>1.2.4</b> The study of importance, influence and attachment</a></li>
<li class="chapter" data-level="1.2.5" data-path="everywhere.html"><a href="everywhere.html#graphs-as-data-sources"><i class="fa fa-check"></i><b>1.2.5</b> Graphs as data sources</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="everywhere.html"><a href="everywhere.html#the-purpose-structure-and-organization-of-this-book"><i class="fa fa-check"></i><b>1.3</b> The purpose, structure and organization of this book</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="r-intro.html"><a href="r-intro.html"><i class="fa fa-check"></i><b>2</b> The Basics of the R Programming Language</a>
<ul>
<li class="chapter" data-level="2.1" data-path="r-intro.html"><a href="r-intro.html#what-is-r"><i class="fa fa-check"></i><b>2.1</b> What is R?</a></li>
<li class="chapter" data-level="2.2" data-path="r-intro.html"><a href="r-intro.html#how-to-start-using-r"><i class="fa fa-check"></i><b>2.2</b> How to start using R</a></li>
<li class="chapter" data-level="2.3" data-path="r-intro.html"><a href="r-intro.html#data-in-r"><i class="fa fa-check"></i><b>2.3</b> Data in R</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="r-intro.html"><a href="r-intro.html#data-types"><i class="fa fa-check"></i><b>2.3.1</b> Data types</a></li>
<li class="chapter" data-level="2.3.2" data-path="r-intro.html"><a href="r-intro.html#homogeneous-data-structures"><i class="fa fa-check"></i><b>2.3.2</b> Homogeneous data structures</a></li>
<li class="chapter" data-level="2.3.3" data-path="r-intro.html"><a href="r-intro.html#heterogeneous-data-structures"><i class="fa fa-check"></i><b>2.3.3</b> Heterogeneous data structures</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="r-intro.html"><a href="r-intro.html#working-with-dataframes"><i class="fa fa-check"></i><b>2.4</b> Working with dataframes</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="r-intro.html"><a href="r-intro.html#loading-and-tidying-data-in-dataframes"><i class="fa fa-check"></i><b>2.4.1</b> Loading and tidying data in dataframes</a></li>
<li class="chapter" data-level="2.4.2" data-path="r-intro.html"><a href="r-intro.html#manipulating-dataframes"><i class="fa fa-check"></i><b>2.4.2</b> Manipulating dataframes</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="r-intro.html"><a href="r-intro.html#functions-packages-and-libraries"><i class="fa fa-check"></i><b>2.5</b> Functions, packages and libraries</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="r-intro.html"><a href="r-intro.html#using-functions"><i class="fa fa-check"></i><b>2.5.1</b> Using functions</a></li>
<li class="chapter" data-level="2.5.2" data-path="r-intro.html"><a href="r-intro.html#help-with-functions"><i class="fa fa-check"></i><b>2.5.2</b> Help with functions</a></li>
<li class="chapter" data-level="2.5.3" data-path="r-intro.html"><a href="r-intro.html#writing-your-own-functions"><i class="fa fa-check"></i><b>2.5.3</b> Writing your own functions</a></li>
<li class="chapter" data-level="2.5.4" data-path="r-intro.html"><a href="r-intro.html#installing-packages"><i class="fa fa-check"></i><b>2.5.4</b> Installing packages</a></li>
<li class="chapter" data-level="2.5.5" data-path="r-intro.html"><a href="r-intro.html#using-packages"><i class="fa fa-check"></i><b>2.5.5</b> Using packages</a></li>
<li class="chapter" data-level="2.5.6" data-path="r-intro.html"><a href="r-intro.html#the-pipe-operator"><i class="fa fa-check"></i><b>2.5.6</b> The pipe operator</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="r-intro.html"><a href="r-intro.html#errors-warnings-and-messages"><i class="fa fa-check"></i><b>2.6</b> Errors, warnings and messages</a></li>
<li class="chapter" data-level="2.7" data-path="r-intro.html"><a href="r-intro.html#plotting-and-graphing"><i class="fa fa-check"></i><b>2.7</b> Plotting and graphing</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="r-intro.html"><a href="r-intro.html#plotting-in-base-r"><i class="fa fa-check"></i><b>2.7.1</b> Plotting in base R</a></li>
<li class="chapter" data-level="2.7.2" data-path="r-intro.html"><a href="r-intro.html#specialist-plotting-and-graphing-packages"><i class="fa fa-check"></i><b>2.7.2</b> Specialist plotting and graphing packages</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="r-intro.html"><a href="r-intro.html#documenting-your-work-using-r-markdown"><i class="fa fa-check"></i><b>2.8</b> Documenting your work using R Markdown</a></li>
<li class="chapter" data-level="2.9" data-path="r-intro.html"><a href="r-intro.html#learning-exercises"><i class="fa fa-check"></i><b>2.9</b> Learning exercises</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="r-intro.html"><a href="r-intro.html#discussion-questions"><i class="fa fa-check"></i><b>2.9.1</b> Discussion questions</a></li>
<li class="chapter" data-level="2.9.2" data-path="r-intro.html"><a href="r-intro.html#data-exercises"><i class="fa fa-check"></i><b>2.9.2</b> Data exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="working.html"><a href="working.html"><i class="fa fa-check"></i><b>3</b> Working With Graphs</a>
<ul>
<li class="chapter" data-level="3.1" data-path="working.html"><a href="working.html#elementary-graph-theory"><i class="fa fa-check"></i><b>3.1</b> Elementary Graph Theory</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="working.html"><a href="working.html#graph-def"><i class="fa fa-check"></i><b>3.1.1</b> General definition of a graph</a></li>
<li class="chapter" data-level="3.1.2" data-path="working.html"><a href="working.html#graph-types"><i class="fa fa-check"></i><b>3.1.2</b> Types of graphs</a></li>
<li class="chapter" data-level="3.1.3" data-path="working.html"><a href="working.html#vertex-edge-prop"><i class="fa fa-check"></i><b>3.1.3</b> Vertex and Edge Properties</a></li>
<li class="chapter" data-level="3.1.4" data-path="working.html"><a href="working.html#rep-graphs"><i class="fa fa-check"></i><b>3.1.4</b> Representations of graphs</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="working.html"><a href="working.html#creating-graphs-in-r"><i class="fa fa-check"></i><b>3.2</b> Creating graphs in R</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="working.html"><a href="working.html#creating-a-graph-from-an-edgelist"><i class="fa fa-check"></i><b>3.2.1</b> Creating a graph from an edgelist</a></li>
<li class="chapter" data-level="3.2.2" data-path="working.html"><a href="working.html#creating-a-graph-from-an-adjacency-matrix"><i class="fa fa-check"></i><b>3.2.2</b> Creating a graph from an adjacency matrix</a></li>
<li class="chapter" data-level="3.2.3" data-path="working.html"><a href="working.html#creating-a-graph-from-a-dataframe"><i class="fa fa-check"></i><b>3.2.3</b> Creating a graph from a dataframe</a></li>
<li class="chapter" data-level="3.2.4" data-path="working.html"><a href="working.html#adding-properties-to-the-vertices-and-edges"><i class="fa fa-check"></i><b>3.2.4</b> Adding properties to the vertices and edges</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="working.html"><a href="working.html#creating-graphs-in-python"><i class="fa fa-check"></i><b>3.3</b> Creating graphs in Python</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="working.html"><a href="working.html#creating-a-graph-from-an-edgelist-1"><i class="fa fa-check"></i><b>3.3.1</b> Creating a graph from an edgelist</a></li>
<li class="chapter" data-level="3.3.2" data-path="working.html"><a href="working.html#python-graph-from-adjacency"><i class="fa fa-check"></i><b>3.3.2</b> Creating a graph from an adjacency matrix</a></li>
<li class="chapter" data-level="3.3.3" data-path="working.html"><a href="working.html#adding-vertex-and-edge-properties-to-a-graph"><i class="fa fa-check"></i><b>3.3.3</b> Adding vertex and edge properties to a graph</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="working.html"><a href="working.html#learning-exercises-1"><i class="fa fa-check"></i><b>3.4</b> Learning exercises</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="working.html"><a href="working.html#discussion-questions-1"><i class="fa fa-check"></i><b>3.4.1</b> Discussion questions</a></li>
<li class="chapter" data-level="3.4.2" data-path="working.html"><a href="working.html#data-exercises-1"><i class="fa fa-check"></i><b>3.4.2</b> Data exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="viz-graphs.html"><a href="viz-graphs.html"><i class="fa fa-check"></i><b>4</b> Visualizing Graphs</a>
<ul>
<li class="chapter" data-level="4.1" data-path="viz-graphs.html"><a href="viz-graphs.html#visualizing-graphs-in-r"><i class="fa fa-check"></i><b>4.1</b> Visualizing graphs in R</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="viz-graphs.html"><a href="viz-graphs.html#native-plotting-igraph"><i class="fa fa-check"></i><b>4.1.1</b> Native plotting in <code>igraph</code></a></li>
<li class="chapter" data-level="4.1.2" data-path="viz-graphs.html"><a href="viz-graphs.html#layouts"><i class="fa fa-check"></i><b>4.1.2</b> Graph layouts</a></li>
<li class="chapter" data-level="4.1.3" data-path="viz-graphs.html"><a href="viz-graphs.html#plotting-with-ggraph"><i class="fa fa-check"></i><b>4.1.3</b> Plotting with <code>ggraph</code></a></li>
<li class="chapter" data-level="4.1.4" data-path="viz-graphs.html"><a href="viz-graphs.html#interactive-graph-visualization-in-r"><i class="fa fa-check"></i><b>4.1.4</b> Interactive graph visualization in R</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="viz-graphs.html"><a href="viz-graphs.html#visualizing-graphs-in-python"><i class="fa fa-check"></i><b>4.2</b> Visualizing graphs in Python</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="viz-graphs.html"><a href="viz-graphs.html#static-visualizations-using-networkx-and-matplotlib"><i class="fa fa-check"></i><b>4.2.1</b> Static visualizations using <code>networkx</code> and <code>matplotlib</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="viz-graphs.html"><a href="viz-graphs.html#dynamic-visualization-using-networkx-and-pyvis"><i class="fa fa-check"></i><b>4.2.2</b> Dynamic visualization using <code>networkx</code> and <code>pyvis</code></a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="viz-graphs.html"><a href="viz-graphs.html#learning-exercises-2"><i class="fa fa-check"></i><b>4.3</b> Learning exercises</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="viz-graphs.html"><a href="viz-graphs.html#discussion-questions-2"><i class="fa fa-check"></i><b>4.3.1</b> Discussion questions</a></li>
<li class="chapter" data-level="4.3.2" data-path="viz-graphs.html"><a href="viz-graphs.html#data-exercises-2"><i class="fa fa-check"></i><b>4.3.2</b> Data exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="restructuring-data.html"><a href="restructuring-data.html"><i class="fa fa-check"></i><b>5</b> Restructuring Data For Use in Graphs</a>
<ul>
<li class="chapter" data-level="5.1" data-path="restructuring-data.html"><a href="restructuring-data.html#transforming-data-in-rectangular-tables-for-use-in-graphs"><i class="fa fa-check"></i><b>5.1</b> Transforming data in rectangular tables for use in graphs</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="restructuring-data.html"><a href="restructuring-data.html#creating-a-simple-graph-of-the-chinook-management-hierarchy"><i class="fa fa-check"></i><b>5.1.1</b> Creating a simple graph of the Chinook management hierarchy</a></li>
<li class="chapter" data-level="5.1.2" data-path="restructuring-data.html"><a href="restructuring-data.html#connecting-customers-through-sales-reps"><i class="fa fa-check"></i><b>5.1.2</b> Connecting customers through sales reps</a></li>
<li class="chapter" data-level="5.1.3" data-path="restructuring-data.html"><a href="restructuring-data.html#common-purchases"><i class="fa fa-check"></i><b>5.1.3</b> Connecting customers through common purchases</a></li>
<li class="chapter" data-level="5.1.4" data-path="restructuring-data.html"><a href="restructuring-data.html#approaches-using-python"><i class="fa fa-check"></i><b>5.1.4</b> Approaches using Python</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="restructuring-data.html"><a href="restructuring-data.html#doc-transform"><i class="fa fa-check"></i><b>5.2</b> Transforming data from documents for use in graphs</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="restructuring-data.html"><a href="restructuring-data.html#scraping-the-character-and-scene-data"><i class="fa fa-check"></i><b>5.2.1</b> Scraping the character and scene data</a></li>
<li class="chapter" data-level="5.2.2" data-path="restructuring-data.html"><a href="restructuring-data.html#creating-an-edgelist-from-the-scraped-data"><i class="fa fa-check"></i><b>5.2.2</b> Creating an edgelist from the scraped data</a></li>
<li class="chapter" data-level="5.2.3" data-path="restructuring-data.html"><a href="restructuring-data.html#approaches-in-python"><i class="fa fa-check"></i><b>5.2.3</b> Approaches in Python</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="restructuring-data.html"><a href="restructuring-data.html#learning-exercises-3"><i class="fa fa-check"></i><b>5.3</b> Learning exercises</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="restructuring-data.html"><a href="restructuring-data.html#discussion-questions-3"><i class="fa fa-check"></i><b>5.3.1</b> Discussion questions</a></li>
<li class="chapter" data-level="5.3.2" data-path="restructuring-data.html"><a href="restructuring-data.html#data-exercises-3"><i class="fa fa-check"></i><b>5.3.2</b> Data exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Handbook of Graphs and Networks in People Analytics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="restructuring-data" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Restructuring Data For Use in Graphs</h1>
<p>So far we have learned how to define and visualize graphs to allow us to work with them. But we have made a really big assumption in doing so. We have assumed that the data we need to create our graph is always available in exactly the form in which we will need it. Usually this is an edgelist or a set of dataframes of edges and vertices. In reality, only certain types of data exist in this form by default. Typically, electronic communication data will often — though not always — have a ‘from’ and ‘to’ structure because that is how communication works and because many of the underlying systems like email, calendar or other communication networks are already built on databases that have a graph-like structure.</p>
<p>In reality, there are a lot of problems we may want to apply graph theory to problems where the data does not exist in an way that makes it easy to create a graph from it. In these cases we will need to transform the data from its existing shape to graph-friendly shape — a set of vertices and edges.</p>
<p>There are two important considerations in transforming data into a graph-friendly structure. Both of these considerations depend on the problem you are trying to solve with the graph, as follows:</p>
<ol style="list-style-type: decimal">
<li><p>What entities am I interested in connecting? These will be the vertices of your graph. This could be a single entitiy type like a set of people, or it could be multiple entity types, such as connecting people to organizational units. Complex graphs such as those in graph databases will have multiple entity types but in this chapter we will stick to one entity type in order to keep things simple.</p></li>
<li><p>How do I define the relationship between the vertices. These will be the edges of your graph. Again, there can be multiple relationship types, such as ‘reports to’ or ‘works with,’ depending on how complex your graph needs to be.</p></li>
</ol>
<p>In addition to these considerations, there are also questions of design in how you construct your graph. This is because there is often more than one option for how you can model the entities and relationships you are interested in. For example, imagine that you have two types of relationships where ‘works with’ means that two people have worked together on the same project and ‘located with’ means that two people are based in the same location. One option for modeling these in a single graph is to have a single entity type (people) connected with edges that have a ‘relationship type’ property. Another option is to have several entity types — individuals, projects and locations — as vertices, and to connect individuals to projects and locations using a single edge type that means ‘is a member of.’ In the first option the relatonships are modeled directly, but in the second they are modeled indirectly. Both may work equally well for the problem that is being solved by the graph, but one choice may be more useful or efficient than another.</p>
<p>To be able to go about these sorts of transformations requires technical and data design skills and judgment. There is no ‘one size fits all’ solution. The transformations required and how you go about them depends a great deal on the context and the purpose of the work. Nevertheless, in this chapter we will demonstrate two examples which reflect common situations where data needs to be transformed from a graph-unfriendly to a graph-friendly structure. Working through these examples should illustrate a simple design process to follow and help demonstrate typical data transformation methods that could be applied in other common situations.</p>
<p>In the first example, we will study a situation where data exists in traditional rectangular tables, but where we need to transform it in order to understand connections that we cannot understand directly from the tables themselves. This is extremely common in practice and many organizations perform these sorts of transformations in order to populate graph databases from more traditional data sources. In the second example, we will study how to extract information from documents in a way that helps us understand connections between entities in those documents. This is another common situation that has strong applications in general, but has particular potential in the fields of law and crime investigation. Both these examples will be demonstrated in detail using R, and the last section of the chapter will provide guidance for performing similar transformations using Python.</p>
<div id="transforming-data-in-rectangular-tables-for-use-in-graphs" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Transforming data in rectangular tables for use in graphs</h2>
<p>In this example we are going to use some simplified tables from the <em>Chinook</em> database - an open source database which contains records of the customers, employees and transactions of a music sales company. We will be working with four simplified tables from this database which you can load from the <code>onadata</code> package now or download from the internet as follows:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="restructuring-data.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download chinook database tables</span></span>
<span id="cb210-2"><a href="restructuring-data.html#cb210-2" aria-hidden="true" tabindex="-1"></a>chinook_employees <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://ona-book.org/data/chinook_employees.csv&quot;</span>)</span>
<span id="cb210-3"><a href="restructuring-data.html#cb210-3" aria-hidden="true" tabindex="-1"></a>chinook_customers <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://ona-book.org/data/chinook_customers.csv&quot;</span>)</span>
<span id="cb210-4"><a href="restructuring-data.html#cb210-4" aria-hidden="true" tabindex="-1"></a>chinook_invoices <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://ona-book.org/data/chinook_invoices.csv&quot;</span>)</span>
<span id="cb210-5"><a href="restructuring-data.html#cb210-5" aria-hidden="true" tabindex="-1"></a>chinook_items <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;https://ona-book.org/data/chinook_items.csv&quot;</span>)</span>
<span id="cb210-6"><a href="restructuring-data.html#cb210-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-7"><a href="restructuring-data.html#cb210-7" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed for later visualizations</span></span>
<span id="cb210-8"><a href="restructuring-data.html#cb210-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code></pre></div>
<div id="creating-a-simple-graph-of-the-chinook-management-hierarchy" class="section level3" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Creating a simple graph of the Chinook management hierarchy</h3>
<p>First, let’s take a look at a simple example of a graph that already exists in this data. Let’s take a look at a few rows of the <code>chinook_employees</code> data set.</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="restructuring-data.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(chinook_employees)</span></code></pre></div>
<pre><code>##   EmployeeId FirstName LastName ReportsTo
## 1          1    Andrew    Adams        NA
## 2          2     Nancy  Edwards         1
## 3          3      Jane  Peacock         2
## 4          4  Margaret     Park         2
## 5          5     Steve  Johnson         2
## 6          6   Michael Mitchell         1</code></pre>
<p>We can see straight away that we can easily create a graph of the management relationships using this table. In such a graph, we would have a single entity type (the employee) as the vertices and the management relationship (‘is a manager of’) as the edges. For simplicity. let’s use first names as vertex names. By joining our data on itself, using <code>EmployeeId = ReportsTo</code>, we can create two columns with the first names of those in each management relationship.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="restructuring-data.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load dplyr for tidy manipulation in this chapter</span></span>
<span id="cb213-2"><a href="restructuring-data.html#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb213-3"><a href="restructuring-data.html#cb213-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-4"><a href="restructuring-data.html#cb213-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create edgelist</span></span>
<span id="cb213-5"><a href="restructuring-data.html#cb213-5" aria-hidden="true" tabindex="-1"></a>(orgchart_edgelist <span class="ot">&lt;-</span> chinook_employees <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb213-6"><a href="restructuring-data.html#cb213-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(chinook_employees, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;EmployeeId&quot;</span> <span class="ot">=</span> <span class="st">&quot;ReportsTo&quot;</span>)))</span></code></pre></div>
<pre><code>##   EmployeeId FirstName.x LastName.x ReportsTo EmployeeId.y FirstName.y LastName.y
## 1          1      Andrew      Adams        NA            2       Nancy    Edwards
## 2          1      Andrew      Adams        NA            6     Michael   Mitchell
## 3          2       Nancy    Edwards         1            3        Jane    Peacock
## 4          2       Nancy    Edwards         1            4    Margaret       Park
## 5          2       Nancy    Edwards         1            5       Steve    Johnson
## 6          6     Michael   Mitchell         1            7      Robert       King
## 7          6     Michael   Mitchell         1            8       Laura   Callahan</code></pre>
<p>We can see that the <code>FirstName.x</code> is the manager and so should be the <code>from</code> column and the <code>Firstname.y</code> column should be the <code>to</code> column in our edgelist. We should also remove rows were there is no edge.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="restructuring-data.html#cb215-1" aria-hidden="true" tabindex="-1"></a>(orgchart_edgelist <span class="ot">&lt;-</span> orgchart_edgelist <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb215-2"><a href="restructuring-data.html#cb215-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">from =</span> FirstName.x, <span class="at">to =</span> FirstName.y)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb215-3"><a href="restructuring-data.html#cb215-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(from) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(to))</span></code></pre></div>
<pre><code>##      from       to
## 1  Andrew    Nancy
## 2  Andrew  Michael
## 3   Nancy     Jane
## 4   Nancy Margaret
## 5   Nancy    Steve
## 6 Michael   Robert
## 7 Michael    Laura</code></pre>
<p>Now we can create a directed <code>igraph</code> object using the ‘is a manager of’ relationship.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="restructuring-data.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb217-2"><a href="restructuring-data.html#cb217-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-3"><a href="restructuring-data.html#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create orgchart graph</span></span>
<span id="cb217-4"><a href="restructuring-data.html#cb217-4" aria-hidden="true" tabindex="-1"></a>(orgchart <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb217-5"><a href="restructuring-data.html#cb217-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> orgchart_edgelist</span>
<span id="cb217-6"><a href="restructuring-data.html#cb217-6" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div>
<pre><code>## IGRAPH c7a3f37 DN-- 8 7 -- 
## + attr: name (v/c)
## + edges from c7a3f37 (vertex names):
## [1] Andrew -&gt;Nancy    Andrew -&gt;Michael  Nancy  -&gt;Jane     Nancy  -&gt;Margaret Nancy  -&gt;Steve    Michael-&gt;Robert  
## [7] Michael-&gt;Laura</code></pre>
<p>We now have a directed graph with named vertices, so this should be easy to plot. Let’s use <code>ggplot</code> with a dendrogram (tree) layout, as in Figure <a href="restructuring-data.html#fig:chinook-pretty">5.1</a>.</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="restructuring-data.html#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggraph)</span>
<span id="cb219-2"><a href="restructuring-data.html#cb219-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-3"><a href="restructuring-data.html#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create management structure as dendrogram (tree)</span></span>
<span id="cb219-4"><a href="restructuring-data.html#cb219-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(orgchart, <span class="at">layout =</span> <span class="st">&#39;dendrogram&#39;</span>) <span class="sc">+</span> </span>
<span id="cb219-5"><a href="restructuring-data.html#cb219-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_elbow</span>() <span class="sc">+</span></span>
<span id="cb219-6"><a href="restructuring-data.html#cb219-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">fill =</span> <span class="st">&quot;lightblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb219-7"><a href="restructuring-data.html#cb219-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:chinook-pretty"></span>
<img src="_main_files/figure-html/chinook-pretty-1.png" alt="Management hierarchy of Chinook as a tree" width="672" />
<p class="caption">
Figure 5.1: Management hierarchy of Chinook as a tree
</p>
</div>
</div>
<div id="connecting-customers-through-sales-reps" class="section level3" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Connecting customers through sales reps</h3>
<p>Let’s now try to build a graph based an a slightly more complex definition of connection. We are going to connect Chinook’s customers based on whether or not they share the same support rep. First, let’s take a look at the <code>customers</code> table.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="restructuring-data.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(chinook_customers)</span></code></pre></div>
<pre><code>##   CustomerId FirstName    LastName SupportRepId
## 1          1      Luís   Gonçalves            3
## 2          2    Leonie      Köhler            5
## 3          3  François    Tremblay            3
## 4          4     Bjørn      Hansen            4
## 5          5 František Wichterlová            4
## 6          6    Helena        Holý            5</code></pre>
<p>We see a <code>SupportRepId</code> field which corresponds to the <code>EmployeeId</code> field in the <code>chinook_employees</code> table. We can join these tables to get an edgelist of customers to support rep. Let’s also create full names for better reference.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="restructuring-data.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create customer to support rep edgelist</span></span>
<span id="cb222-2"><a href="restructuring-data.html#cb222-2" aria-hidden="true" tabindex="-1"></a>cust_reps <span class="ot">&lt;-</span> chinook_customers <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb222-3"><a href="restructuring-data.html#cb222-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(chinook_employees, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;SupportRepId&quot;</span> <span class="ot">=</span> <span class="st">&quot;EmployeeId&quot;</span>)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb222-4"><a href="restructuring-data.html#cb222-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb222-5"><a href="restructuring-data.html#cb222-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">CustomerName =</span> <span class="fu">paste</span>(FirstName.x, LastName.x),</span>
<span id="cb222-6"><a href="restructuring-data.html#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">RepName =</span> <span class="fu">paste</span>(FirstName.y, LastName.y)</span>
<span id="cb222-7"><a href="restructuring-data.html#cb222-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb222-8"><a href="restructuring-data.html#cb222-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(RepName, CustomerName, SupportRepId)</span>
<span id="cb222-9"><a href="restructuring-data.html#cb222-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-10"><a href="restructuring-data.html#cb222-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_reps)</span></code></pre></div>
<pre><code>##         RepName          CustomerName SupportRepId
## 1  Jane Peacock        Luís Gonçalves            3
## 2 Steve Johnson         Leonie Köhler            5
## 3  Jane Peacock     François Tremblay            3
## 4 Margaret Park          Bjørn Hansen            4
## 5 Margaret Park František Wichterlová            4
## 6 Steve Johnson           Helena Holý            5</code></pre>
<p>Now we have an option of creating two types of graphs. First we could create a graph from the data as is, using the <code>CustomerName</code> and <code>RepName</code> as the edgelist, and where the relationship is ‘is a customer of.’ Let’s create that graph, and view it in Figure <a href="restructuring-data.html#fig:cust-rep">5.2</a>. We see a tripartite graph with a hub-and-spoke shape.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="restructuring-data.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create igraph</span></span>
<span id="cb224-2"><a href="restructuring-data.html#cb224-2" aria-hidden="true" tabindex="-1"></a>cust_rep_graph <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb224-3"><a href="restructuring-data.html#cb224-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> cust_reps</span>
<span id="cb224-4"><a href="restructuring-data.html#cb224-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb224-5"><a href="restructuring-data.html#cb224-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-6"><a href="restructuring-data.html#cb224-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create customer and rep property for vertices</span></span>
<span id="cb224-7"><a href="restructuring-data.html#cb224-7" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(cust_rep_graph)<span class="sc">$</span>Type <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb224-8"><a href="restructuring-data.html#cb224-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">V</span>(cust_rep_graph)<span class="sc">$</span>name <span class="sc">%in%</span> cust_reps<span class="sc">$</span>RepName,</span>
<span id="cb224-9"><a href="restructuring-data.html#cb224-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Rep&quot;</span>,</span>
<span id="cb224-10"><a href="restructuring-data.html#cb224-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Customer&quot;</span></span>
<span id="cb224-11"><a href="restructuring-data.html#cb224-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb224-12"><a href="restructuring-data.html#cb224-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-13"><a href="restructuring-data.html#cb224-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(cust_rep_graph, <span class="at">layout =</span> <span class="st">&quot;fr&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-14"><a href="restructuring-data.html#cb224-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb224-15"><a href="restructuring-data.html#cb224-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_label</span>(<span class="fu">aes</span>(<span class="at">color =</span> Type, <span class="at">label =</span> name), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb224-16"><a href="restructuring-data.html#cb224-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cust-rep"></span>
<img src="_main_files/figure-html/cust-rep-1.png" alt="Graph of Chinook customers connected to their sales reps" width="672" />
<p class="caption">
Figure 5.2: Graph of Chinook customers connected to their sales reps
</p>
</div>
<p>Recall our original objective is to connect customers if they have the same support rep. It is possible to use this graph to do this indirectly, applying the logic that customers are connected if there is a path between them in this graph. However we may wish to ignore the support reps completely in our graph and make directed connections between customers if they share the same support rep. To do this we need to do some further joining to our previous <code>cust_reps</code> data frame.</p>
<p>If we join this dataframe back to our <code>chinook_customers</code> dataframe, we can get customer to customer connections via a common support rep as follows:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="restructuring-data.html#cb225-1" aria-hidden="true" tabindex="-1"></a>cust_cust <span class="ot">&lt;-</span> cust_reps <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb225-2"><a href="restructuring-data.html#cb225-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(chinook_customers, <span class="at">by =</span> <span class="st">&quot;SupportRepId&quot;</span>) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb225-3"><a href="restructuring-data.html#cb225-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Customer1 =</span> CustomerName,</span>
<span id="cb225-4"><a href="restructuring-data.html#cb225-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">Customer2 =</span> <span class="fu">paste</span>(FirstName, LastName)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb225-5"><a href="restructuring-data.html#cb225-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Customer1, Customer2, RepName)</span>
<span id="cb225-6"><a href="restructuring-data.html#cb225-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-7"><a href="restructuring-data.html#cb225-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_cust)</span></code></pre></div>
<pre><code>##        Customer1         Customer2      RepName
## 1 Luís Gonçalves    Luís Gonçalves Jane Peacock
## 2 Luís Gonçalves François Tremblay Jane Peacock
## 3 Luís Gonçalves   Roberto Almeida Jane Peacock
## 4 Luís Gonçalves Jennifer Peterson Jane Peacock
## 5 Luís Gonçalves   Michelle Brooks Jane Peacock
## 6 Luís Gonçalves         Tim Goyer Jane Peacock</code></pre>
<p>Now we are not interested in creating a pseudograph where customers are connected to themselves, we regard edges with reverse order as the same.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="restructuring-data.html#cb227-1" aria-hidden="true" tabindex="-1"></a>customer_network_edgelist <span class="ot">&lt;-</span> cust_cust <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb227-2"><a href="restructuring-data.html#cb227-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb227-3"><a href="restructuring-data.html#cb227-3" aria-hidden="true" tabindex="-1"></a>    Customer1 <span class="sc">!=</span> Customer2</span>
<span id="cb227-4"><a href="restructuring-data.html#cb227-4" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb227-5"><a href="restructuring-data.html#cb227-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-6"><a href="restructuring-data.html#cb227-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(customer_network_edgelist)</span></code></pre></div>
<pre><code>##        Customer1         Customer2      RepName
## 1 Luís Gonçalves François Tremblay Jane Peacock
## 2 Luís Gonçalves   Roberto Almeida Jane Peacock
## 3 Luís Gonçalves Jennifer Peterson Jane Peacock
## 4 Luís Gonçalves   Michelle Brooks Jane Peacock
## 5 Luís Gonçalves         Tim Goyer Jane Peacock
## 6 Luís Gonçalves     Frank Ralston Jane Peacock</code></pre>
<p>Now we have a network edgelist we can work with, with a <code>RepName</code> edge property to indicate which support rep connects the customers. Note that relationships will appear in both directions in this dataset, but we can take care of that by choosing to represent them in an undirected graph. Let’s build and visualize the graph, as in <a href="restructuring-data.html#fig:cust-cust">5.3</a>. We see a tripartite graph consisting of three complete subgraphs with the edges color coded by the Support Rep.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="restructuring-data.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create igraph object</span></span>
<span id="cb229-2"><a href="restructuring-data.html#cb229-2" aria-hidden="true" tabindex="-1"></a>customer_network <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb229-3"><a href="restructuring-data.html#cb229-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> customer_network_edgelist,</span>
<span id="cb229-4"><a href="restructuring-data.html#cb229-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">directed =</span> <span class="cn">FALSE</span></span>
<span id="cb229-5"><a href="restructuring-data.html#cb229-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb229-6"><a href="restructuring-data.html#cb229-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-7"><a href="restructuring-data.html#cb229-7" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize</span></span>
<span id="cb229-8"><a href="restructuring-data.html#cb229-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(customer_network) <span class="sc">+</span></span>
<span id="cb229-9"><a href="restructuring-data.html#cb229-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">color =</span> RepName), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb229-10"><a href="restructuring-data.html#cb229-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_point</span>(<span class="at">color =</span> <span class="st">&quot;lightblue&quot;</span>, <span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb229-11"><a href="restructuring-data.html#cb229-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cust-cust"></span>
<img src="_main_files/figure-html/cust-cust-1.png" alt="Customer to customer network for Chinook based on customers sharing the same sales rep" width="672" />
<p class="caption">
Figure 5.3: Customer to customer network for Chinook based on customers sharing the same sales rep
</p>
</div>
<div class="thinkahead">
<p><strong>Thinking ahead:</strong> Recall from Section <a href="working.html#graph-types">3.1.2</a> that a complete graph is a graph where every pair of vertices are connected by an edge. Can you see how it follows from the shape of the graph in Figure <a href="restructuring-data.html#fig:cust-rep">5.2</a> that when we transform the data to produce Figure <a href="restructuring-data.html#fig:cust-cust">5.3</a>, we expect to produce complete subgraphs? Can you also see how visually dense those complete subgraphs are? We will look at the measurement of density in graphs later, but a complete graph will alwqys have a density of 1.</p>
</div>
<!--
```{=latex}
\colorbox{babyblueeyes}{
\begin{minipage}{\textwidth}
\textbf{Playing around:} Recall from Section \ref{graph-types} that a complete graph is a graph where every pair of vertices are connected by an edge.  Can you see how it follows from the shape of the graph in Figure \ref{fig:cust-rep} that when we transform the data to produce Figure \ref{fig:cust-cust}, we expect to produce complete subgraphs?  Can you also see how visually dense those complete subgraphs are?  We will look at the measurement of density in graphs later, but a complete graph will alwqys have a density of 1.
\end{minipage}
}
```
-->
</div>
<div id="common-purchases" class="section level3" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Connecting customers through common purchases</h3>
<p>To illustrate a further layer of complexity in reshaping data for use in graphs, let’s imagine that we want to connect customers on the basis of them purchasing common products. We may wish to set some parameters to this relationship - for example a connection might be based on a minimum number of common products purchased, to give us flexibility around the definition of connection.</p>
<p>To do this we will need to use three tables - <code>chinook_customers</code>, <code>chinook_invoices</code> and <code>chinook_items</code>. To associate a given customer with a purchased item, we will need to join all three of these tables together. Let’s take a quick look at the latter two.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="restructuring-data.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(chinook_invoices, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   InvoiceId CustomerId
## 1         1          2
## 2         2          4
## 3         3          8</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="restructuring-data.html#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(chinook_items, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   InvoiceId TrackId
## 1         1       2
## 2         1       4
## 3         2       6</code></pre>
<p>We can regard the <code>TrackId</code> as an item, and using a couple of joins we can quickly match customers with items. It is possible that customers may have purchased the same item numerous times, but we are not interested in that for this work and so we just need the distinct customer and track pairings.</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="restructuring-data.html#cb234-1" aria-hidden="true" tabindex="-1"></a>cust_item <span class="ot">&lt;-</span> chinook_customers <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb234-2"><a href="restructuring-data.html#cb234-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(chinook_invoices) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb234-3"><a href="restructuring-data.html#cb234-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(chinook_items) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb234-4"><a href="restructuring-data.html#cb234-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">CustName =</span> <span class="fu">paste</span>(FirstName, LastName)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb234-5"><a href="restructuring-data.html#cb234-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(CustName, TrackId) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb234-6"><a href="restructuring-data.html#cb234-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span>
<span id="cb234-7"><a href="restructuring-data.html#cb234-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-8"><a href="restructuring-data.html#cb234-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_item, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##         CustName TrackId
## 1 Luís Gonçalves    3247
## 2 Luís Gonçalves    3248
## 3 Luís Gonçalves     447</code></pre>
<p>Similar to our previous example, we can now use this to create an undirected network with two vertex entities: customer and item.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="restructuring-data.html#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initiate graph object</span></span>
<span id="cb236-2"><a href="restructuring-data.html#cb236-2" aria-hidden="true" tabindex="-1"></a>customer_item_network <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb236-3"><a href="restructuring-data.html#cb236-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> cust_item,</span>
<span id="cb236-4"><a href="restructuring-data.html#cb236-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">directed =</span> <span class="cn">FALSE</span></span>
<span id="cb236-5"><a href="restructuring-data.html#cb236-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb236-6"><a href="restructuring-data.html#cb236-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-7"><a href="restructuring-data.html#cb236-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create vertex type</span></span>
<span id="cb236-8"><a href="restructuring-data.html#cb236-8" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(customer_item_network)<span class="sc">$</span>Type <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb236-9"><a href="restructuring-data.html#cb236-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">V</span>(customer_item_network)<span class="sc">$</span>name <span class="sc">%in%</span> cust_item<span class="sc">$</span>TrackId,</span>
<span id="cb236-10"><a href="restructuring-data.html#cb236-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Item&quot;</span>,</span>
<span id="cb236-11"><a href="restructuring-data.html#cb236-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Customer&quot;</span></span>
<span id="cb236-12"><a href="restructuring-data.html#cb236-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This is a big network, let’s visualize it simply, as in Figure <a href="restructuring-data.html#fig:cust-item-viz">5.4</a>.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="restructuring-data.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(customer_item_network, <span class="at">layout =</span> <span class="st">&quot;fr&quot;</span>) <span class="sc">+</span></span>
<span id="cb237-2"><a href="restructuring-data.html#cb237-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb237-3"><a href="restructuring-data.html#cb237-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> Type), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb237-4"><a href="restructuring-data.html#cb237-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cust-item-viz"></span>
<img src="_main_files/figure-html/cust-item-viz-1.png" alt="Network connecting customers via items purchased" width="672" />
<p class="caption">
Figure 5.4: Network connecting customers via items purchased
</p>
</div>
<p>We can see from looking at this graph that there are a large number of items that only one customer has purchased. Therefore the items themselves seem to be extraneous information for this particular use case. If we are not interested in the items themselves, we can instead creating the connections between customer directly. In a similar way to the previous problem, we can join the <code>cust_item</code> table on itself to connect customers based on common item purchases, and we should remove links between the same customer.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="restructuring-data.html#cb238-1" aria-hidden="true" tabindex="-1"></a>cust_cust_itemjoin <span class="ot">&lt;-</span> cust_item <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb238-2"><a href="restructuring-data.html#cb238-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(cust_item, <span class="at">by =</span> <span class="st">&quot;TrackId&quot;</span>) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb238-3"><a href="restructuring-data.html#cb238-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">CustName1 =</span> CustName.x, <span class="at">CustName2 =</span> CustName.y, TrackId) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb238-4"><a href="restructuring-data.html#cb238-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(CustName1 <span class="sc">!=</span> CustName2)</span>
<span id="cb238-5"><a href="restructuring-data.html#cb238-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-6"><a href="restructuring-data.html#cb238-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_cust_itemjoin)</span></code></pre></div>
<pre><code>##        CustName1          CustName2 TrackId
## 1 Luís Gonçalves     Edward Francis     449
## 2 Luís Gonçalves Richard Cunningham    1157
## 3 Luís Gonçalves Richard Cunningham    1169
## 4 Luís Gonçalves      Astrid Gruber    2991
## 5 Luís Gonçalves         Emma Jones     280
## 6 Luís Gonçalves         Emma Jones     298</code></pre>
<p>The issue with this data set is that it will count every instance of a common item purchase twicw, with the customers in opposite orders, and this is double counting. So we need to group the pairs of customers irrelevant of their order and ensure we don’t double up on items.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="restructuring-data.html#cb240-1" aria-hidden="true" tabindex="-1"></a>cust_item_network <span class="ot">&lt;-</span> cust_cust_itemjoin <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb240-2"><a href="restructuring-data.html#cb240-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(<span class="at">Cust1 =</span> <span class="fu">pmin</span>(CustName1, CustName2), <span class="at">Cust2 =</span> <span class="fu">pmax</span>(CustName1, CustName2)) <span class="sc">%&gt;%</span></span>
<span id="cb240-3"><a href="restructuring-data.html#cb240-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">TrackId =</span> <span class="fu">unique</span>(TrackId), <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span>)</span>
<span id="cb240-4"><a href="restructuring-data.html#cb240-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-5"><a href="restructuring-data.html#cb240-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_item_network)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   Cust1          Cust2           TrackId
##   &lt;chr&gt;          &lt;chr&gt;             &lt;int&gt;
## 1 Aaron Mitchell Alexandre Rocha    2054
## 2 Aaron Mitchell Bjørn Hansen       1626
## 3 Aaron Mitchell Enrique Muñoz      2027
## 4 Aaron Mitchell Hugh O&#39;Reilly      2018
## 5 Aaron Mitchell Niklas Schröder     857
## 6 Aaron Mitchell Phil Hughes        1822</code></pre>
<p>If that worked we should see that the table <code>cust_cust_itemjoin</code> has twice as many rows as <code>cust_item_network</code>.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="restructuring-data.html#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(cust_cust_itemjoin)<span class="sc">/</span><span class="fu">nrow</span>(cust_item_network)</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>This looks good. So we now can count up how many common items each pair of customers purchased.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="restructuring-data.html#cb244-1" aria-hidden="true" tabindex="-1"></a>cust_item_network <span class="ot">&lt;-</span> cust_item_network <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb244-2"><a href="restructuring-data.html#cb244-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(Cust1, Cust2, <span class="at">name =</span> <span class="st">&quot;Items&quot;</span>) </span>
<span id="cb244-3"><a href="restructuring-data.html#cb244-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-4"><a href="restructuring-data.html#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cust_item_network)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   Cust1          Cust2           Items
##   &lt;chr&gt;          &lt;chr&gt;           &lt;int&gt;
## 1 Aaron Mitchell Alexandre Rocha     1
## 2 Aaron Mitchell Bjørn Hansen        1
## 3 Aaron Mitchell Enrique Muñoz       1
## 4 Aaron Mitchell Hugh O&#39;Reilly       1
## 5 Aaron Mitchell Niklas Schröder     1
## 6 Aaron Mitchell Phil Hughes         1</code></pre>
<p>We are ready to construct our graph, with <code>Items</code> as an edge property. We can visualize it with an edge color code indicating how many common items were purchased, as in Figure <a href="restructuring-data.html#fig:cust-items-coded">5.5</a>.</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="restructuring-data.html#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create undirected graph</span></span>
<span id="cb246-2"><a href="restructuring-data.html#cb246-2" aria-hidden="true" tabindex="-1"></a>custtocust_network <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb246-3"><a href="restructuring-data.html#cb246-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> cust_item_network,</span>
<span id="cb246-4"><a href="restructuring-data.html#cb246-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">directed =</span> <span class="cn">FALSE</span></span>
<span id="cb246-5"><a href="restructuring-data.html#cb246-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb246-6"><a href="restructuring-data.html#cb246-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-7"><a href="restructuring-data.html#cb246-7" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize with edges color coded by no of items</span></span>
<span id="cb246-8"><a href="restructuring-data.html#cb246-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(custtocust_network) <span class="sc">+</span></span>
<span id="cb246-9"><a href="restructuring-data.html#cb246-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">color =</span> Items), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb246-10"><a href="restructuring-data.html#cb246-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_point</span>(<span class="at">color =</span> <span class="st">&quot;lightblue&quot;</span>, <span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb246-11"><a href="restructuring-data.html#cb246-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cust-items-coded"></span>
<img src="_main_files/figure-html/cust-items-coded-1.png" alt="Chinook customer to customer network based on common item purchases" width="672" />
<p class="caption">
Figure 5.5: Chinook customer to customer network based on common item purchases
</p>
</div>
<p>If we wish, we can restrict the definition of connection. For example, we may define it as ‘purchased at least two items in common,’ as in Figure <a href="restructuring-data.html#fig:cust-item-two">5.6</a>. We can use the <code>subgraph()</code> function in <code>igraph</code> for this, and the result reveal a bipartite graph that looks quite symmetrical, indicating that there appear to be two independent groups of customers with who have some overlap purchasing behavior.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="restructuring-data.html#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select edges that have Item value of at least 2</span></span>
<span id="cb247-2"><a href="restructuring-data.html#cb247-2" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">E</span>(custtocust_network)[<span class="fu">E</span>(custtocust_network)<span class="sc">$</span>Items <span class="sc">&gt;=</span> <span class="dv">2</span>]</span>
<span id="cb247-3"><a href="restructuring-data.html#cb247-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-4"><a href="restructuring-data.html#cb247-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create subgraph using these edges</span></span>
<span id="cb247-5"><a href="restructuring-data.html#cb247-5" aria-hidden="true" tabindex="-1"></a>two_item_graph <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">subgraph.edges</span>(custtocust_network, <span class="at">eids =</span> edges)</span>
<span id="cb247-6"><a href="restructuring-data.html#cb247-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-7"><a href="restructuring-data.html#cb247-7" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise</span></span>
<span id="cb247-8"><a href="restructuring-data.html#cb247-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(two_item_graph) <span class="sc">+</span></span>
<span id="cb247-9"><a href="restructuring-data.html#cb247-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb247-10"><a href="restructuring-data.html#cb247-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_point</span>(<span class="at">color =</span> <span class="st">&quot;lightblue&quot;</span>, <span class="at">size =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb247-11"><a href="restructuring-data.html#cb247-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cust-item-two"></span>
<img src="_main_files/figure-html/cust-item-two-1.png" alt="Chinook customer to customer network based at least two common items purchased" width="672" />
<p class="caption">
Figure 5.6: Chinook customer to customer network based at least two common items purchased
</p>
</div>
</div>
<div id="approaches-using-python" class="section level3" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Approaches using Python</h3>
<p>To illustrate similar approaches in Python, we will redo the work in Section <a href="restructuring-data.html#common-purchases">5.1.3</a> using Python. First we will download the various datasets.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb248-1"><a href="restructuring-data.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb248-2"><a href="restructuring-data.html#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb248-3"><a href="restructuring-data.html#cb248-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-4"><a href="restructuring-data.html#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="co"># download chinook database tables</span></span>
<span id="cb248-5"><a href="restructuring-data.html#cb248-5" aria-hidden="true" tabindex="-1"></a>chinook_customers <span class="op">=</span> pd.read_csv(<span class="st">&quot;https://ona-book.org/data/chinook_customers.csv&quot;</span>)</span>
<span id="cb248-6"><a href="restructuring-data.html#cb248-6" aria-hidden="true" tabindex="-1"></a>chinook_invoices <span class="op">=</span> pd.read_csv(<span class="st">&quot;https://ona-book.org/data/chinook_invoices.csv&quot;</span>)</span>
<span id="cb248-7"><a href="restructuring-data.html#cb248-7" aria-hidden="true" tabindex="-1"></a>chinook_items <span class="op">=</span> pd.read_csv(<span class="st">&quot;https://ona-book.org/data/chinook_items.csv&quot;</span>)</span>
<span id="cb248-8"><a href="restructuring-data.html#cb248-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-9"><a href="restructuring-data.html#cb248-9" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed for later visualizations</span></span>
<span id="cb248-10"><a href="restructuring-data.html#cb248-10" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">123</span>)</span></code></pre></div>
<p>Now we join the three tables together, create the FullName variable and ensure that we don’t have any duplicate relationships:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb249-1"><a href="restructuring-data.html#cb249-1" aria-hidden="true" tabindex="-1"></a>joined_tables <span class="op">=</span> pd.merge(</span>
<span id="cb249-2"><a href="restructuring-data.html#cb249-2" aria-hidden="true" tabindex="-1"></a>  chinook_customers,</span>
<span id="cb249-3"><a href="restructuring-data.html#cb249-3" aria-hidden="true" tabindex="-1"></a>  chinook_invoices</span>
<span id="cb249-4"><a href="restructuring-data.html#cb249-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb249-5"><a href="restructuring-data.html#cb249-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-6"><a href="restructuring-data.html#cb249-6" aria-hidden="true" tabindex="-1"></a>joined_tables <span class="op">=</span> pd.merge(joined_tables, chinook_items)</span>
<span id="cb249-7"><a href="restructuring-data.html#cb249-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-8"><a href="restructuring-data.html#cb249-8" aria-hidden="true" tabindex="-1"></a>joined_tables[<span class="st">&#39;FullName&#39;</span>] <span class="op">=</span> joined_tables[<span class="st">&#39;FirstName&#39;</span>] <span class="op">+</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb249-9"><a href="restructuring-data.html#cb249-9" aria-hidden="true" tabindex="-1"></a>joined_tables[<span class="st">&#39;LastName&#39;</span>]</span>
<span id="cb249-10"><a href="restructuring-data.html#cb249-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-11"><a href="restructuring-data.html#cb249-11" aria-hidden="true" tabindex="-1"></a>cust_item_table <span class="op">=</span> joined_tables[[<span class="st">&#39;FullName&#39;</span>, <span class="st">&#39;TrackId&#39;</span>]].drop_duplicates()</span>
<span id="cb249-12"><a href="restructuring-data.html#cb249-12" aria-hidden="true" tabindex="-1"></a>cust_item_table.head()</span></code></pre></div>
<pre><code>##          FullName  TrackId
## 0  Luís Gonçalves     3247
## 1  Luís Gonçalves     3248
## 2  Luís Gonçalves      447
## 3  Luís Gonçalves      449
## 4  Luís Gonçalves      451</code></pre>
<p>Now we can create a graph of connections between customers and items and visualize it as in Figure <a href="restructuring-data.html#fig:custitempy">5.7</a>.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb251-1"><a href="restructuring-data.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb251-2"><a href="restructuring-data.html#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb251-3"><a href="restructuring-data.html#cb251-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-4"><a href="restructuring-data.html#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create networkx object</span></span>
<span id="cb251-5"><a href="restructuring-data.html#cb251-5" aria-hidden="true" tabindex="-1"></a>cust_item_network <span class="op">=</span> nx.from_pandas_edgelist(cust_item_table,</span>
<span id="cb251-6"><a href="restructuring-data.html#cb251-6" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> <span class="st">&quot;FullName&quot;</span>, target <span class="op">=</span> <span class="st">&quot;TrackId&quot;</span>)</span>
<span id="cb251-7"><a href="restructuring-data.html#cb251-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-8"><a href="restructuring-data.html#cb251-8" aria-hidden="true" tabindex="-1"></a><span class="co"># color items differently to customers</span></span>
<span id="cb251-9"><a href="restructuring-data.html#cb251-9" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">&quot;red&quot;</span> <span class="cf">if</span> i <span class="kw">in</span> cust_item_table[<span class="st">&#39;FullName&#39;</span>].values <span class="cf">else</span> <span class="st">&quot;green&quot;</span></span>
<span id="cb251-10"><a href="restructuring-data.html#cb251-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> cust_item_network.nodes]</span>
<span id="cb251-11"><a href="restructuring-data.html#cb251-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-12"><a href="restructuring-data.html#cb251-12" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize</span></span>
<span id="cb251-13"><a href="restructuring-data.html#cb251-13" aria-hidden="true" tabindex="-1"></a>nx.draw_networkx(cust_item_network, node_color <span class="op">=</span> colors, node_size <span class="op">=</span> <span class="dv">2</span>,</span>
<span id="cb251-14"><a href="restructuring-data.html#cb251-14" aria-hidden="true" tabindex="-1"></a>edge_color <span class="op">=</span> <span class="st">&quot;grey&quot;</span>, with_labels <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb251-15"><a href="restructuring-data.html#cb251-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:custitempy"></span>
<img src="_main_files/figure-html/unnamed-chunk-60-1.png" alt="Visualization of the Chinook customer-to-item network" width="672" />
<p class="caption">
Figure 5.7: Visualization of the Chinook customer-to-item network
</p>
</div>
<p>Now to create the customer-to-customer network based on common item purchases, we do further joins on the data set, and remove connections between the same customer.</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb252-1"><a href="restructuring-data.html#cb252-1" aria-hidden="true" tabindex="-1"></a>cust_cust_table <span class="op">=</span> pd.merge(cust_item_table, cust_item_table,</span>
<span id="cb252-2"><a href="restructuring-data.html#cb252-2" aria-hidden="true" tabindex="-1"></a>on <span class="op">=</span> <span class="st">&quot;TrackId&quot;</span>)</span>
<span id="cb252-3"><a href="restructuring-data.html#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="restructuring-data.html#cb252-4" aria-hidden="true" tabindex="-1"></a>cust_cust_table.rename(</span>
<span id="cb252-5"><a href="restructuring-data.html#cb252-5" aria-hidden="true" tabindex="-1"></a>  columns<span class="op">=</span>{<span class="st">&#39;FullName_x&#39;</span> :<span class="st">&#39;CustName1&#39;</span>, <span class="st">&#39;FullName_y&#39;</span> :<span class="st">&#39;CustName2&#39;</span>},</span>
<span id="cb252-6"><a href="restructuring-data.html#cb252-6" aria-hidden="true" tabindex="-1"></a>  inplace<span class="op">=</span><span class="va">True</span></span>
<span id="cb252-7"><a href="restructuring-data.html#cb252-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb252-8"><a href="restructuring-data.html#cb252-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-9"><a href="restructuring-data.html#cb252-9" aria-hidden="true" tabindex="-1"></a>cust_cust_table <span class="op">=</span> cust_cust_table[</span>
<span id="cb252-10"><a href="restructuring-data.html#cb252-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>(cust_cust_table[<span class="st">&#39;CustName1&#39;</span>] <span class="op">==</span> cust_cust_table[<span class="st">&#39;CustName2&#39;</span>])</span>
<span id="cb252-11"><a href="restructuring-data.html#cb252-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb252-12"><a href="restructuring-data.html#cb252-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-13"><a href="restructuring-data.html#cb252-13" aria-hidden="true" tabindex="-1"></a>cust_cust_table.head()</span></code></pre></div>
<pre><code>##              CustName1  TrackId           CustName2
## 4       Luís Gonçalves      449      Edward Francis
## 5       Edward Francis      449      Luís Gonçalves
## 11      Luís Gonçalves     1157  Richard Cunningham
## 12  Richard Cunningham     1157      Luís Gonçalves
## 17      Luís Gonçalves     1169  Richard Cunningham</code></pre>
<p>Now we can drop duplicates based on the <code>TrackId</code>, count the items by pair of customers, and we will have our final edgelist:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb254-1"><a href="restructuring-data.html#cb254-1" aria-hidden="true" tabindex="-1"></a>cust_cust_table <span class="op">=</span> cust_cust_table.drop_duplicates(<span class="st">&#39;TrackId&#39;</span>)</span>
<span id="cb254-2"><a href="restructuring-data.html#cb254-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-3"><a href="restructuring-data.html#cb254-3" aria-hidden="true" tabindex="-1"></a>cust_cust_table <span class="op">=</span> cust_cust_table.groupby([<span class="st">&#39;CustName1&#39;</span>, <span class="st">&#39;CustName2&#39;</span>], </span>
<span id="cb254-4"><a href="restructuring-data.html#cb254-4" aria-hidden="true" tabindex="-1"></a>as_index <span class="op">=</span> <span class="va">False</span>).TrackId.nunique()</span>
<span id="cb254-5"><a href="restructuring-data.html#cb254-5" aria-hidden="true" tabindex="-1"></a>cust_cust_table.rename(columns <span class="op">=</span> {<span class="st">&#39;TrackId&#39;</span>: <span class="st">&#39;Items&#39;</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb254-6"><a href="restructuring-data.html#cb254-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-7"><a href="restructuring-data.html#cb254-7" aria-hidden="true" tabindex="-1"></a>cust_cust_table.head()</span></code></pre></div>
<pre><code>##          CustName1        CustName2  Items
## 0   Aaron Mitchell    Enrique Muñoz      1
## 1   Aaron Mitchell    Hugh O&#39;Reilly      1
## 2   Aaron Mitchell  Niklas Schröder      1
## 3   Aaron Mitchell      Phil Hughes      1
## 4  Alexandre Rocha   Aaron Mitchell      1</code></pre>
<p>Now we are ready to create and visualize our customer-to-customer network, as in Figure <a href="restructuring-data.html#fig:custcustpy">5.8</a>.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb256-1"><a href="restructuring-data.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create networkx object</span></span>
<span id="cb256-2"><a href="restructuring-data.html#cb256-2" aria-hidden="true" tabindex="-1"></a>cust_cust_network <span class="op">=</span> nx.from_pandas_edgelist(cust_cust_table,</span>
<span id="cb256-3"><a href="restructuring-data.html#cb256-3" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> <span class="st">&quot;CustName1&quot;</span>, target <span class="op">=</span> <span class="st">&quot;CustName2&quot;</span>, edge_attr <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb256-4"><a href="restructuring-data.html#cb256-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-5"><a href="restructuring-data.html#cb256-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-6"><a href="restructuring-data.html#cb256-6" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize</span></span>
<span id="cb256-7"><a href="restructuring-data.html#cb256-7" aria-hidden="true" tabindex="-1"></a>nx.draw_networkx(cust_cust_network, node_color <span class="op">=</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb256-8"><a href="restructuring-data.html#cb256-8" aria-hidden="true" tabindex="-1"></a>edge_color <span class="op">=</span> <span class="st">&quot;grey&quot;</span>, with_labels <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb256-9"><a href="restructuring-data.html#cb256-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:custcustpy"></span>
<img src="_main_files/figure-html/unnamed-chunk-60-3.png" alt="Visualization of the Chinook customer-to-customer network based on common item purchases" width="672" />
<p class="caption">
Figure 5.8: Visualization of the Chinook customer-to-customer network based on common item purchases
</p>
</div>
<p>And if we wish to restrict connections to two or more common item purchases, we can create a subgraph based on the number of items, as in Figure <a href="restructuring-data.html#fig:twoitempy">5.9</a>.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb257-1"><a href="restructuring-data.html#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get edges with items &gt;= 2</span></span>
<span id="cb257-2"><a href="restructuring-data.html#cb257-2" aria-hidden="true" tabindex="-1"></a>twoitem_edges <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">list</span>(cust_cust_network.edges) <span class="cf">if</span> </span>
<span id="cb257-3"><a href="restructuring-data.html#cb257-3" aria-hidden="true" tabindex="-1"></a>cust_cust_network.edges[i][<span class="st">&#39;Items&#39;</span>] <span class="op">&gt;=</span> <span class="dv">2</span>]</span>
<span id="cb257-4"><a href="restructuring-data.html#cb257-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-5"><a href="restructuring-data.html#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create subgraph</span></span>
<span id="cb257-6"><a href="restructuring-data.html#cb257-6" aria-hidden="true" tabindex="-1"></a>twoitem_network <span class="op">=</span> cust_cust_network.edge_subgraph(twoitem_edges) </span>
<span id="cb257-7"><a href="restructuring-data.html#cb257-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-8"><a href="restructuring-data.html#cb257-8" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize in K-K layout</span></span>
<span id="cb257-9"><a href="restructuring-data.html#cb257-9" aria-hidden="true" tabindex="-1"></a>layout <span class="op">=</span> nx.kamada_kawai_layout(twoitem_network)</span>
<span id="cb257-10"><a href="restructuring-data.html#cb257-10" aria-hidden="true" tabindex="-1"></a>nx.draw_networkx(twoitem_network, node_color <span class="op">=</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb257-11"><a href="restructuring-data.html#cb257-11" aria-hidden="true" tabindex="-1"></a>edge_color <span class="op">=</span> <span class="st">&quot;grey&quot;</span>, with_labels <span class="op">=</span> <span class="va">False</span>, pos <span class="op">=</span> layout)</span>
<span id="cb257-12"><a href="restructuring-data.html#cb257-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:twoitempy"></span>
<img src="_main_files/figure-html/unnamed-chunk-60-5.png" alt="Visualization of the Chinook customer-to-customer network based on at least two item purchases" width="672" />
<p class="caption">
Figure 5.9: Visualization of the Chinook customer-to-customer network based on at least two item purchases
</p>
</div>
</div>
</div>
<div id="doc-transform" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Transforming data from documents for use in graphs</h2>
<p>In this example, we will look at how to extract information that sits in semi-structured documents and convert it to a graph-like shape to allow us to understand connections between actors or entities in those documents. Semi-structured documents are documents which have a certain expected format through which we can reliably identify important actors or entities. These could be legal contracts, financial statements or other types of structured forms. Through extracting entities from these documents, we can identify important relationships between them, such as co-publishing, financial transactions or contractual obligations.</p>
<p>To illustrate this we will show how to extract information from a TV script in a way where we can determine which characters have spoken in the same scene together, and then use this information to create a network of TV characters. We will use an episode script from the hit TV comedy show <em>Friends</em>. A full set of scripts from all episodes of <em>Friends</em> can be found online at <code>https://fangj.github.io/friends/</code>, and later in this book we will be working with a substantial network for characters from the entire series. For this exercise, however, we will keep it simple and just focus on the character network from the first episode. The script of the first episode can be found at <code>https://fangj.github.io/friends/season/0101.html</code>.</p>
<div id="scraping-the-character-and-scene-data" class="section level3" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> Scraping the character and scene data</h3>
<p>First we will look at how to obtain a list of numbered scenes and the characters in each scene, through ‘scraping’ these details from the online script. To help us with this we will use the <code>rvest</code> R package, which is designed for scraping information from web pages.</p>
<p>Let’s take a look at the web code for Season 1 Episode 1. You can do this by opening the script webpage in Google Chrome and then pressing CMD+Option+C (or Ctrl+Shift+C in Windows) to open the Elements Console where you can view the HTML code of the page side-by-side with the page itself.</p>
<p>One of the things we can see immediately is that most of the words that precede a colon are of interest to us. In fact, most of them are character names that say something in a scene. We also see that lines that contain the string “Scene:” are pretty reliable indicators of scene boundaries.</p>
<p>The first thing we probably want to do get this HTML code in a list or vector of nodes which represent the different pieces of formatting and text in the document. Since this will contain the separated lines spoken by each character, this will be really helpful for us to work from. So let’s download the HTML code, break it into nodes so that we have a nice tidy vector of script content.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="restructuring-data.html#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb258-2"><a href="restructuring-data.html#cb258-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-3"><a href="restructuring-data.html#cb258-3" aria-hidden="true" tabindex="-1"></a>url_string <span class="ot">&lt;-</span> <span class="st">&quot;https://fangj.github.io/friends/season/0101.html&quot;</span></span>
<span id="cb258-4"><a href="restructuring-data.html#cb258-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-5"><a href="restructuring-data.html#cb258-5" aria-hidden="true" tabindex="-1"></a><span class="co"># installing rvest also installs xml2</span></span>
<span id="cb258-6"><a href="restructuring-data.html#cb258-6" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(url_string) <span class="sc">%&gt;%</span> </span>
<span id="cb258-7"><a href="restructuring-data.html#cb258-7" aria-hidden="true" tabindex="-1"></a>      xml2<span class="sc">::</span><span class="fu">as_list</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb258-8"><a href="restructuring-data.html#cb258-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unlist</span>()</span>
<span id="cb258-9"><a href="restructuring-data.html#cb258-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-10"><a href="restructuring-data.html#cb258-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nodes)</span></code></pre></div>
<pre><code>##                                                          html.head.title 
##  &quot;The One Where Monica Gets a New Roomate (The Pilot-The Uncut Version)&quot; 
##                                                               html.body1 
##                                                                   &quot;\n\n&quot; 
##                                                             html.body.h1 
## &quot;The One Where Monica Gets a New Roommate (The Pilot-The Uncut Version)&quot; 
##                                                               html.body3 
##                                                                   &quot;\n\n&quot; 
##                                                           html.body.font 
##                                                                   &quot;\n\n&quot; 
##                                                         html.body.font.p 
##                               &quot;Written by: Marta Kauffman &amp; David Crane&quot;</code></pre>
<p>This has generated a character vector that contains a lot of different split out parts of the script, but most importantly it contains the lines from the script, for example:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="restructuring-data.html#cb260-1" aria-hidden="true" tabindex="-1"></a>nodes[<span class="dv">16</span>]</span></code></pre></div>
<pre><code>##                                                       html.body.font.p 
## &quot;[Scene: Central Perk, Chandler, Joey, Phoebe, and Monica are there.]&quot;</code></pre>
<p>Now, to generate something useful for our task, we need to create a vector that contains the word ‘New Scene’ if the line represents the beginning of a scene, and the name of the character if the line represents something spoken by a character. This will be the best format for what we want to do.</p>
<p>The first thing we will need to do is swap any text string containing “Scene:” to the string “New Scene.” We can do this quite simply using an <code>ifelse()</code> on the nodes vector, where we use <code>grepl()</code> to identify which entries are in nodes that contain the string “Scene:”</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="restructuring-data.html#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># swap lines containing the string &#39;Scene:&#39; with &#39;New Scene&#39; </span></span>
<span id="cb262-2"><a href="restructuring-data.html#cb262-2" aria-hidden="true" tabindex="-1"></a>nodes_newscene <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&quot;Scene:&quot;</span>, nodes), <span class="st">&quot;New Scene&quot;</span>, nodes)</span>
<span id="cb262-3"><a href="restructuring-data.html#cb262-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-4"><a href="restructuring-data.html#cb262-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check that there are at least a few &#39;New Scene&#39; entries now</span></span>
<span id="cb262-5"><a href="restructuring-data.html#cb262-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(nodes_newscene <span class="sc">==</span> <span class="st">&quot;New Scene&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 15</code></pre>
<p>That worked nicely. Now, you might also have noticed that for dialogue purposes, character names precede a colon at the beginning of a line. So that might be a nice way to extract the names of characters with speaking parts in a scene (although it might give us a few other things that have preceded colons in the script also, but we can deal with that later).</p>
<p>So what we will do is use regular expression syntax (regex) to tell R that we are looking for anything at the beginning of a line preceding a colon. We will use a lookahead regex string as follows: <code>^[A-Za-z ]+(?=:)</code>.</p>
<p>Let’s look at that string and make sure we know what it means. The <code>^[A-Za-z ]+</code> component means ‘find any sub-string of alphabetic text of any length including spaces at the beginning of a string.’ The part in parentheses is known as a lookahead — it means look ahead of that sub-string of text and find a colon as the next character. This is therefore instructing R to find any string of alphabetic text at the start of a line that precedes a colon and return it. If we use the R package <code>stringr</code> and its function <code>str_extract()</code> with this regex syntax, it will go through every entry of the <code>nodes</code> vector and transform it to just the first string of text found before a colon. If no such string is found it will return an NA value. This is great for us because we know that, for the purpose of dialogue, characters names are always at the start of nodes, so we certainly won’t miss any if we just take the first instance in each line. We should also, for safety, not mess with the scene breaks we have put into our vector.</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="restructuring-data.html#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb264-2"><a href="restructuring-data.html#cb264-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-3"><a href="restructuring-data.html#cb264-3" aria-hidden="true" tabindex="-1"></a><span class="co"># outside of &#39;New Scene&#39; tags extract anything before : in every line </span></span>
<span id="cb264-4"><a href="restructuring-data.html#cb264-4" aria-hidden="true" tabindex="-1"></a>nodes_char <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(nodes_newscene <span class="sc">!=</span> <span class="st">&quot;New Scene&quot;</span>, </span>
<span id="cb264-5"><a href="restructuring-data.html#cb264-5" aria-hidden="true" tabindex="-1"></a>                     stringr<span class="sc">::</span><span class="fu">str_extract</span>(nodes_newscene, <span class="st">&quot;^[A-Za-z ]+(?=:)&quot;</span>), </span>
<span id="cb264-6"><a href="restructuring-data.html#cb264-6" aria-hidden="true" tabindex="-1"></a>                     nodes_newscene)</span>
<span id="cb264-7"><a href="restructuring-data.html#cb264-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-8"><a href="restructuring-data.html#cb264-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check a sample</span></span>
<span id="cb264-9"><a href="restructuring-data.html#cb264-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb264-10"><a href="restructuring-data.html#cb264-10" aria-hidden="true" tabindex="-1"></a>nodes_char[<span class="fu">sample</span>(<span class="dv">30</span>)]</span></code></pre></div>
<pre><code>##  [1] NA           NA           NA           NA           NA           &quot;Monica&quot;     NA           NA           NA          
## [10] NA           NA           &quot;Chandler&quot;   NA           NA           NA           NA           NA           NA          
## [19] NA           NA           NA           NA           NA           &quot;Joey&quot;       &quot;Phoebe&quot;     NA           &quot;New Scene&quot; 
## [28] NA           NA           &quot;Written by&quot;</code></pre>
<p>So this is working, but we have more cleaning to do. For example, we will want to get rid of the <code>NA</code> values. We will also see if we take a look that there is a ‘character’ called ‘All’ which probably should not be in our network. We can also see phrases like ‘Written by’ which are not dialogue characters, and " and " which involves combinations of characters. So we can create special commands to remove any instances of these phrases<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>.</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="restructuring-data.html#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove NAs</span></span>
<span id="cb266-2"><a href="restructuring-data.html#cb266-2" aria-hidden="true" tabindex="-1"></a>nodes_char_clean1 <span class="ot">&lt;-</span> nodes_char[<span class="sc">!</span><span class="fu">is.na</span>(nodes_char)] </span>
<span id="cb266-3"><a href="restructuring-data.html#cb266-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-4"><a href="restructuring-data.html#cb266-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remove entries with &quot;all&quot;, &quot; and &quot; or &quot;by&quot; irrelevant of the case</span></span>
<span id="cb266-5"><a href="restructuring-data.html#cb266-5" aria-hidden="true" tabindex="-1"></a>nodes_char_clean2 <span class="ot">&lt;-</span> nodes_char_clean1[</span>
<span id="cb266-6"><a href="restructuring-data.html#cb266-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;all| and |by&quot;</span>, <span class="fu">tolower</span>(nodes_char_clean1))</span>
<span id="cb266-7"><a href="restructuring-data.html#cb266-7" aria-hidden="true" tabindex="-1"></a>] </span>
<span id="cb266-8"><a href="restructuring-data.html#cb266-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-9"><a href="restructuring-data.html#cb266-9" aria-hidden="true" tabindex="-1"></a><span class="co"># check </span></span>
<span id="cb266-10"><a href="restructuring-data.html#cb266-10" aria-hidden="true" tabindex="-1"></a>nodes_char_clean2[<span class="fu">sample</span>(<span class="dv">20</span>)]</span></code></pre></div>
<pre><code>##  [1] &quot;Chandler&quot;  &quot;Monica&quot;    &quot;Chandler&quot;  &quot;Monica&quot;    &quot;Phoebe&quot;    &quot;Joey&quot;      &quot;Phoebe&quot;    &quot;Joey&quot;      &quot;Monica&quot;    &quot;Monica&quot;   
## [11] &quot;Chandler&quot;  &quot;Chandler&quot;  &quot;New Scene&quot; &quot;Ross&quot;      &quot;Joey&quot;      &quot;Chandler&quot;  &quot;Joey&quot;      &quot;Chandler&quot;  &quot;Phoebe&quot;    &quot;Chandler&quot;</code></pre>
<p>Let’s assume our cleaning is done and we have a nice vector that contains either the names of characters that are speaking lines in the episode or “New Scene” to indicate that we are crossing a scene boundary. We now just need to convert this vector into a simple dataframe with two columns for scene and character. We already have our character lists, so we really just need to iterate through our nodes vector and for each entry, count the number of previous occurrences of “New Scene” and add one.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="restructuring-data.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number each scene by counting previous &quot;New Scene&quot; entries and adding 1</span></span>
<span id="cb268-2"><a href="restructuring-data.html#cb268-2" aria-hidden="true" tabindex="-1"></a>scene_count <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb268-3"><a href="restructuring-data.html#cb268-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-4"><a href="restructuring-data.html#cb268-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nodes_char_clean2)) {</span>
<span id="cb268-5"><a href="restructuring-data.html#cb268-5" aria-hidden="true" tabindex="-1"></a>  scene_count[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">grepl</span>(<span class="st">&quot;New Scene&quot;</span>, nodes_char_clean2[<span class="dv">1</span><span class="sc">:</span>i])) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb268-6"><a href="restructuring-data.html#cb268-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Then we can finalize our dataframe by putting our two vectors together and removing any repeated characters in the same scene. We can also correct for situations where the script starts with a New Scene and we can consistently format our character names to title case, to account for different case typing.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="restructuring-data.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb269-2"><a href="restructuring-data.html#cb269-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-3"><a href="restructuring-data.html#cb269-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">scene =</span> scene_count, <span class="at">character =</span> nodes_char_clean2) <span class="sc">%&gt;%</span> </span>
<span id="cb269-4"><a href="restructuring-data.html#cb269-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(character <span class="sc">!=</span> <span class="st">&quot;New Scene&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb269-5"><a href="restructuring-data.html#cb269-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(scene, character) <span class="sc">%&gt;%</span> </span>
<span id="cb269-6"><a href="restructuring-data.html#cb269-6" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb269-7"><a href="restructuring-data.html#cb269-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">scene =</span> scene <span class="sc">-</span> <span class="fu">min</span>(scene) <span class="sc">+</span> <span class="dv">1</span>, <span class="co"># set first scene number to 1</span></span>
<span id="cb269-8"><a href="restructuring-data.html#cb269-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">character =</span> character <span class="sc">%&gt;%</span> </span>
<span id="cb269-9"><a href="restructuring-data.html#cb269-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tolower</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb269-10"><a href="restructuring-data.html#cb269-10" aria-hidden="true" tabindex="-1"></a>        tools<span class="sc">::</span><span class="fu">toTitleCase</span>()</span>
<span id="cb269-11"><a href="restructuring-data.html#cb269-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="co"># title case</span></span>
<span id="cb269-12"><a href="restructuring-data.html#cb269-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-13"><a href="restructuring-data.html#cb269-13" aria-hidden="true" tabindex="-1"></a><span class="co"># check the first ten rows</span></span>
<span id="cb269-14"><a href="restructuring-data.html#cb269-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(results, <span class="dv">10</span>)</span></code></pre></div>
<pre><code>##    scene character
## 1      1    Monica
## 2      1      Joey
## 3      1  Chandler
## 4      1    Phoebe
## 5      1      Ross
## 6      1    Rachel
## 7      1  Waitress
## 8      2    Monica
## 9      2  Chandler
## 10     2      Ross</code></pre>
</div>
<div id="creating-an-edgelist-from-the-scraped-data" class="section level3" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Creating an edgelist from the scraped data</h3>
<p>Now we have scraped the data on which characters have spoken in each numbered scene, we can now try ot build an edgelist between characters based on whether they have both spoken in the same scene. We can also consider adding a weight to each edge based on the number of scenes in which both characters have spoken.</p>
<p>To do this, we will need to generate a set of unique pairs from the list of characters in each scene. To illustrate, let’s look at the characters in Scene 11:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="restructuring-data.html#cb271-1" aria-hidden="true" tabindex="-1"></a>(scene11_chars <span class="ot">&lt;-</span> results <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb271-2"><a href="restructuring-data.html#cb271-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(scene <span class="sc">==</span> <span class="dv">11</span>) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb271-3"><a href="restructuring-data.html#cb271-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(character))</span></code></pre></div>
<pre><code>## [1] &quot;Rachel&quot;   &quot;Chandler&quot; &quot;Joey&quot;     &quot;Monica&quot;   &quot;Paul&quot;</code></pre>
<p>The unique pairs from this scene are formed by starting with the first character in the list and pairing with each of those that follow, then starting with the second and pairing with each that follows, and so on until the final pair is formed from the second-to-last and last elements of the list. So for Scene 11 our unique pairs would be:</p>
<ul>
<li><strong>Rachel pairs:</strong> Rachel-Chandler, Rachel-Joey, Rachel-Monica, Rachel-Paul</li>
<li><strong>Chandler pairs:</strong> Chandler-Joey, Chandler-Monica, Chandler-Paul</li>
<li><strong>Joey pairs:</strong> Joey-Monica, Joey-Paul</li>
<li><strong>Monica pairs</strong>: Monica-Paul</li>
</ul>
<p>So we should write a function called <code>unique_pairs()</code> which accepts a character vector of arbitrary length and forms pairs progressively in this way. Then we can apply this function to every scene.</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="restructuring-data.html#cb273-1" aria-hidden="true" tabindex="-1"></a>unique_pairs <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">char_vector =</span> <span class="cn">NULL</span>) {</span>
<span id="cb273-2"><a href="restructuring-data.html#cb273-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ensure unique entries</span></span>
<span id="cb273-3"><a href="restructuring-data.html#cb273-3" aria-hidden="true" tabindex="-1"></a>  vector <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">unique</span>(char_vector))</span>
<span id="cb273-4"><a href="restructuring-data.html#cb273-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create from-to column dataframe</span></span>
<span id="cb273-5"><a href="restructuring-data.html#cb273-5" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">char1 =</span> <span class="fu">character</span>(), </span>
<span id="cb273-6"><a href="restructuring-data.html#cb273-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">char2 =</span> <span class="fu">character</span>(), </span>
<span id="cb273-7"><a href="restructuring-data.html#cb273-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb273-8"><a href="restructuring-data.html#cb273-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iterate over each entry to form pairs</span></span>
<span id="cb273-9"><a href="restructuring-data.html#cb273-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(vector) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb273-10"><a href="restructuring-data.html#cb273-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(vector) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb273-11"><a href="restructuring-data.html#cb273-11" aria-hidden="true" tabindex="-1"></a>      char1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(vector[i], <span class="fu">length</span>(vector) <span class="sc">-</span> i) </span>
<span id="cb273-12"><a href="restructuring-data.html#cb273-12" aria-hidden="true" tabindex="-1"></a>      char2 <span class="ot">&lt;-</span> vector[(i <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span> <span class="fu">length</span>(vector)] </span>
<span id="cb273-13"><a href="restructuring-data.html#cb273-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb273-14"><a href="restructuring-data.html#cb273-14" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb273-15"><a href="restructuring-data.html#cb273-15" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb273-16"><a href="restructuring-data.html#cb273-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>(<span class="at">char1 =</span> char1, </span>
<span id="cb273-17"><a href="restructuring-data.html#cb273-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">char2 =</span> char2, </span>
<span id="cb273-18"><a href="restructuring-data.html#cb273-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>) </span>
<span id="cb273-19"><a href="restructuring-data.html#cb273-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb273-20"><a href="restructuring-data.html#cb273-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb273-21"><a href="restructuring-data.html#cb273-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb273-22"><a href="restructuring-data.html#cb273-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#return result</span></span>
<span id="cb273-23"><a href="restructuring-data.html#cb273-23" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb273-24"><a href="restructuring-data.html#cb273-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now let’s test our new function on the Scene 11 characters:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="restructuring-data.html#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique_pairs</span>(scene11_chars)</span></code></pre></div>
<pre><code>##       char1    char2
## 1    Rachel Chandler
## 2    Rachel     Joey
## 3    Rachel   Monica
## 4    Rachel     Paul
## 5  Chandler     Joey
## 6  Chandler   Monica
## 7  Chandler     Paul
## 8      Joey   Monica
## 9      Joey     Paul
## 10   Monica     Paul</code></pre>
<p>That looks right. Now we can easily generate our edgelist from this episode by applying our new function to each scene.</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="restructuring-data.html#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run unique_pairs by scene</span></span>
<span id="cb276-2"><a href="restructuring-data.html#cb276-2" aria-hidden="true" tabindex="-1"></a>friends_ep101 <span class="ot">&lt;-</span> results <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb276-3"><a href="restructuring-data.html#cb276-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(scene) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb276-4"><a href="restructuring-data.html#cb276-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="fu">unique_pairs</span>(character)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb276-5"><a href="restructuring-data.html#cb276-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb276-6"><a href="restructuring-data.html#cb276-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-7"><a href="restructuring-data.html#cb276-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb276-8"><a href="restructuring-data.html#cb276-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(friends_ep101)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   scene char1  char2   
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
## 1     1 Monica Joey    
## 2     1 Monica Chandler
## 3     1 Monica Phoebe  
## 4     1 Monica Ross    
## 5     1 Monica Rachel  
## 6     1 Monica Waitress</code></pre>
<p>This looks like it worked. Now we can just count the number of time each distinct pair occurs in order to get our edge weights (making sure to ignore the order of the characters).</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="restructuring-data.html#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create weight as count of scenes </span></span>
<span id="cb278-2"><a href="restructuring-data.html#cb278-2" aria-hidden="true" tabindex="-1"></a>friends_ep101_edgelist <span class="ot">&lt;-</span> friends_ep101 <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb278-3"><a href="restructuring-data.html#cb278-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>scene) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb278-4"><a href="restructuring-data.html#cb278-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">from =</span> <span class="fu">pmin</span>(char1, char2), <span class="at">to =</span> <span class="fu">pmax</span>(char1, char2)) <span class="sc">|</span><span class="er">&gt;</span> </span>
<span id="cb278-5"><a href="restructuring-data.html#cb278-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">count</span>(from, to, <span class="at">name =</span> <span class="st">&quot;weight&quot;</span>)</span>
<span id="cb278-6"><a href="restructuring-data.html#cb278-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-7"><a href="restructuring-data.html#cb278-7" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb278-8"><a href="restructuring-data.html#cb278-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(friends_ep101_edgelist)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   from     to       weight
##   &lt;chr&gt;    &lt;chr&gt;     &lt;int&gt;
## 1 Chandler Customer      1
## 2 Chandler Joey          8
## 3 Chandler Monica        6
## 4 Chandler Paul          2
## 5 Chandler Phoebe        5
## 6 Chandler Rachel        6</code></pre>
<p>We can now use this edgelist to create an undirected network graph for the first episode of <em>Friends</em>. First we will create an <code>igraph</code> object and then we will visualize it using edge thickness based on weights, as in Figure <a href="restructuring-data.html#fig:friends-ep1-network">5.10</a>.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="restructuring-data.html#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create igraph object</span></span>
<span id="cb280-2"><a href="restructuring-data.html#cb280-2" aria-hidden="true" tabindex="-1"></a>friends_ep1_network <span class="ot">&lt;-</span> igraph<span class="sc">::</span><span class="fu">graph_from_data_frame</span>(</span>
<span id="cb280-3"><a href="restructuring-data.html#cb280-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">d =</span> friends_ep101_edgelist,</span>
<span id="cb280-4"><a href="restructuring-data.html#cb280-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">directed =</span> <span class="cn">FALSE</span></span>
<span id="cb280-5"><a href="restructuring-data.html#cb280-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb280-6"><a href="restructuring-data.html#cb280-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-7"><a href="restructuring-data.html#cb280-7" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize</span></span>
<span id="cb280-8"><a href="restructuring-data.html#cb280-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggraph</span>(friends_ep1_network) <span class="sc">+</span></span>
<span id="cb280-9"><a href="restructuring-data.html#cb280-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_edge_link</span>(<span class="fu">aes</span>(<span class="at">edge_width =</span> weight), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb280-10"><a href="restructuring-data.html#cb280-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb280-11"><a href="restructuring-data.html#cb280-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_node_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb280-12"><a href="restructuring-data.html#cb280-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:friends-ep1-network"></span>
<img src="_main_files/figure-html/friends-ep1-network-1.png" alt="Visualization of the network of characters in Episode 1 of Friends, based on characters speaking in the same scene together" width="672" />
<p class="caption">
Figure 5.10: Visualization of the network of characters in Episode 1 of Friends, based on characters speaking in the same scene together
</p>
</div>
</div>
<div id="approaches-in-python" class="section level3" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Approaches in Python</h3>
<p>To repeat the work in Section <a href="restructuring-data.html#doc-transform">5.2</a> in Python, we will use the <code>BeautifulSoup</code> package to scrape our web script of the first episode of <em>Friends</em>.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb281-1"><a href="restructuring-data.html#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb281-2"><a href="restructuring-data.html#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb281-3"><a href="restructuring-data.html#cb281-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-4"><a href="restructuring-data.html#cb281-4" aria-hidden="true" tabindex="-1"></a>url<span class="op">=</span><span class="st">&quot;https://fangj.github.io/friends/season/0101.html&quot;</span></span>
<span id="cb281-5"><a href="restructuring-data.html#cb281-5" aria-hidden="true" tabindex="-1"></a>script <span class="op">=</span> requests.get(url)</span>
<span id="cb281-6"><a href="restructuring-data.html#cb281-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-7"><a href="restructuring-data.html#cb281-7" aria-hidden="true" tabindex="-1"></a><span class="co"># parse the html of the page</span></span>
<span id="cb281-8"><a href="restructuring-data.html#cb281-8" aria-hidden="true" tabindex="-1"></a>friends_ep1 <span class="op">=</span> BeautifulSoup(script.text, <span class="st">&quot;html.parser&quot;</span>)</span></code></pre></div>
<p>The object <code>friends_ep1</code> contains all the HTML code of the script web page. Now we need to look for the string <code>Scene:</code> and replace it with the the string <code>&lt;b&gt;New Scene:&lt;/b&gt;</code>. It should be clear soon why I am putting the replacement string in bold HTML tags.</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb282-1"><a href="restructuring-data.html#cb282-1" aria-hidden="true" tabindex="-1"></a>originalString <span class="op">=</span> <span class="st">&quot;Scene:&quot;</span></span>
<span id="cb282-2"><a href="restructuring-data.html#cb282-2" aria-hidden="true" tabindex="-1"></a>replaceString <span class="op">=</span> <span class="st">&quot;&lt;b&gt;New Scene:&lt;/b&gt;&quot;</span></span>
<span id="cb282-3"><a href="restructuring-data.html#cb282-3" aria-hidden="true" tabindex="-1"></a>friends_ep1_replace <span class="op">=</span> BeautifulSoup(<span class="bu">str</span>(friends_ep1).replace(originalString, </span>
<span id="cb282-4"><a href="restructuring-data.html#cb282-4" aria-hidden="true" tabindex="-1"></a>replaceString))</span></code></pre></div>
<p>Now we know from viewing the web page or inspecting the HTML code that the characters names who are speaking in scenes will be inside bold or strong tags, so firstly lets get everything that is in bold in the document, and then let’s match for any alphabetic string including spaces prior to a colon using regular expressions. This should include the <code>New Scene</code> tags that we created in the last step.</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb283-1"><a href="restructuring-data.html#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb283-2"><a href="restructuring-data.html#cb283-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-3"><a href="restructuring-data.html#cb283-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find everything in bold tags with alpha preceding a colon</span></span>
<span id="cb283-4"><a href="restructuring-data.html#cb283-4" aria-hidden="true" tabindex="-1"></a>searchstring <span class="op">=</span> re.<span class="bu">compile</span>(<span class="st">&quot;^[A-Za-z ]+(?=:)&quot;</span>)</span>
<span id="cb283-5"><a href="restructuring-data.html#cb283-5" aria-hidden="true" tabindex="-1"></a>friends_ep1_bold <span class="op">=</span> friends_ep1_replace.find_all([<span class="st">&#39;b&#39;</span>, <span class="st">&#39;strong&#39;</span>], </span>
<span id="cb283-6"><a href="restructuring-data.html#cb283-6" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> searchstring)</span>
<span id="cb283-7"><a href="restructuring-data.html#cb283-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-8"><a href="restructuring-data.html#cb283-8" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the text and remove colons</span></span>
<span id="cb283-9"><a href="restructuring-data.html#cb283-9" aria-hidden="true" tabindex="-1"></a>friends_ep1_list <span class="op">=</span> [friends_ep1_bold[i].text.replace(<span class="st">&#39;:&#39;</span>, <span class="st">&#39;&#39;</span>) </span>
<span id="cb283-10"><a href="restructuring-data.html#cb283-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(friends_ep1_bold) <span class="op">-</span> <span class="dv">1</span>)]</span>
<span id="cb283-11"><a href="restructuring-data.html#cb283-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-12"><a href="restructuring-data.html#cb283-12" aria-hidden="true" tabindex="-1"></a><span class="co"># check a sample</span></span>
<span id="cb283-13"><a href="restructuring-data.html#cb283-13" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span>(friends_ep1_list)</span></code></pre></div>
<pre><code>## {&#39;Chandler&#39;, &#39;Frannie&#39;, &#39;Joey&#39;, &#39;Ross&#39;, &#39;Rachel&#39;, &#39;Phoebe&#39;, &#39;Waitress&#39;, &#39;Paul&#39;, &#39;Chandler &#39;, &#39;Monica&#39;, &#39;New Scene&#39;, &#39;All&#39;, &#39;Customer&#39;, &#39;Priest on TV&#39;, &#39;Ross and Rachel&#39;, &#39;Monica &#39;}</code></pre>
<p>This looks promising - new we need to get rid of the ‘All’ and ’ and ’ entries.</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb285-1"><a href="restructuring-data.html#cb285-1" aria-hidden="true" tabindex="-1"></a>friends_ep1_list2<span class="op">=</span>[entry.strip() <span class="cf">for</span> entry <span class="kw">in</span> friends_ep1_list </span>
<span id="cb285-2"><a href="restructuring-data.html#cb285-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;All&quot;</span> <span class="kw">not</span> <span class="kw">in</span> entry <span class="kw">and</span> <span class="st">&quot; and &quot;</span> <span class="kw">not</span> <span class="kw">in</span> entry]</span>
<span id="cb285-3"><a href="restructuring-data.html#cb285-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-4"><a href="restructuring-data.html#cb285-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span>(friends_ep1_list2)</span></code></pre></div>
<pre><code>## {&#39;Chandler&#39;, &#39;Frannie&#39;, &#39;Joey&#39;, &#39;Ross&#39;, &#39;Rachel&#39;, &#39;Phoebe&#39;, &#39;Waitress&#39;, &#39;Paul&#39;, &#39;Monica&#39;, &#39;New Scene&#39;, &#39;Customer&#39;, &#39;Priest on TV&#39;}</code></pre>
<p>Now we are ready ot organize our characters by scene. First we do a scene count, then we create a dataframe and obtain unique character lists by scene:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb287-1"><a href="restructuring-data.html#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb287-2"><a href="restructuring-data.html#cb287-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-3"><a href="restructuring-data.html#cb287-3" aria-hidden="true" tabindex="-1"></a><span class="co"># number each scene by counting previous &quot;New Scene&quot; entries and adding 1</span></span>
<span id="cb287-4"><a href="restructuring-data.html#cb287-4" aria-hidden="true" tabindex="-1"></a>scene_count <span class="op">=</span> []</span>
<span id="cb287-5"><a href="restructuring-data.html#cb287-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-6"><a href="restructuring-data.html#cb287-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,<span class="bu">len</span>(friends_ep1_list2)):</span>
<span id="cb287-7"><a href="restructuring-data.html#cb287-7" aria-hidden="true" tabindex="-1"></a>  scene_count.append(friends_ep1_list2[<span class="dv">0</span>:i<span class="op">+</span><span class="dv">1</span>].count(<span class="st">&quot;New Scene&quot;</span>))</span>
<span id="cb287-8"><a href="restructuring-data.html#cb287-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb287-9"><a href="restructuring-data.html#cb287-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create a pandas dataframe</span></span>
<span id="cb287-10"><a href="restructuring-data.html#cb287-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> {<span class="st">&#39;scene&#39;</span>: scene_count, <span class="st">&#39;character&#39;</span>: friends_ep1_list2}</span>
<span id="cb287-11"><a href="restructuring-data.html#cb287-11" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> pd.DataFrame(df)</span>
<span id="cb287-12"><a href="restructuring-data.html#cb287-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-13"><a href="restructuring-data.html#cb287-13" aria-hidden="true" tabindex="-1"></a><span class="co"># remove New Scene rows</span></span>
<span id="cb287-14"><a href="restructuring-data.html#cb287-14" aria-hidden="true" tabindex="-1"></a>scenes_df <span class="op">=</span> scenes_df[scenes_df.character <span class="op">!=</span> <span class="st">&quot;New Scene&quot;</span>]</span>
<span id="cb287-15"><a href="restructuring-data.html#cb287-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-16"><a href="restructuring-data.html#cb287-16" aria-hidden="true" tabindex="-1"></a><span class="co"># get unique characters by scene</span></span>
<span id="cb287-17"><a href="restructuring-data.html#cb287-17" aria-hidden="true" tabindex="-1"></a>scenes <span class="op">=</span> scenes_df.groupby(<span class="st">&#39;scene&#39;</span>)[<span class="st">&#39;character&#39;</span>].unique()</span>
<span id="cb287-18"><a href="restructuring-data.html#cb287-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-19"><a href="restructuring-data.html#cb287-19" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb287-20"><a href="restructuring-data.html#cb287-20" aria-hidden="true" tabindex="-1"></a>scenes.head()</span></code></pre></div>
<pre><code>## scene
## 1    [Monica, Joey, Chandler, Phoebe, Ross, Rachel,...
## 2    [Monica, Chandler, Ross, Rachel, Phoebe, Joey,...
## 3                                             [Phoebe]
## 4                               [Ross, Joey, Chandler]
## 5                                       [Monica, Paul]
## Name: character, dtype: object</code></pre>
<p>Now we need to create a function to find all unique pairs inside a scene character list:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb289-1"><a href="restructuring-data.html#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb289-2"><a href="restructuring-data.html#cb289-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-3"><a href="restructuring-data.html#cb289-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define function</span></span>
<span id="cb289-4"><a href="restructuring-data.html#cb289-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unique_pairs(chars: <span class="bu">object</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb289-5"><a href="restructuring-data.html#cb289-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># start with uniques</span></span>
<span id="cb289-6"><a href="restructuring-data.html#cb289-6" aria-hidden="true" tabindex="-1"></a>  characters <span class="op">=</span> np.unique(chars)</span>
<span id="cb289-7"><a href="restructuring-data.html#cb289-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create from-to list dataframe</span></span>
<span id="cb289-8"><a href="restructuring-data.html#cb289-8" aria-hidden="true" tabindex="-1"></a>  char1 <span class="op">=</span> []</span>
<span id="cb289-9"><a href="restructuring-data.html#cb289-9" aria-hidden="true" tabindex="-1"></a>  char2 <span class="op">=</span> []</span>
<span id="cb289-10"><a href="restructuring-data.html#cb289-10" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> pd.DataFrame({<span class="st">&#39;char1&#39;</span>: char1, <span class="st">&#39;char2&#39;</span>: char2})</span>
<span id="cb289-11"><a href="restructuring-data.html#cb289-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># iterate over each entry to form pairs</span></span>
<span id="cb289-12"><a href="restructuring-data.html#cb289-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">len</span>(characters) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb289-13"><a href="restructuring-data.html#cb289-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(characters) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb289-14"><a href="restructuring-data.html#cb289-14" aria-hidden="true" tabindex="-1"></a>      char1 <span class="op">=</span> [characters[i]] <span class="op">*</span> (<span class="bu">len</span>(characters) <span class="op">-</span> i <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb289-15"><a href="restructuring-data.html#cb289-15" aria-hidden="true" tabindex="-1"></a>      char2 <span class="op">=</span> [characters[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(characters))]</span>
<span id="cb289-16"><a href="restructuring-data.html#cb289-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># append to dataframe</span></span>
<span id="cb289-17"><a href="restructuring-data.html#cb289-17" aria-hidden="true" tabindex="-1"></a>      df2 <span class="op">=</span> pd.DataFrame({<span class="st">&#39;char1&#39;</span>: char1, <span class="st">&#39;char2&#39;</span>: char2})</span>
<span id="cb289-18"><a href="restructuring-data.html#cb289-18" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> df.append(df2, ignore_index <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb289-19"><a href="restructuring-data.html#cb289-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df</span>
<span id="cb289-20"><a href="restructuring-data.html#cb289-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-21"><a href="restructuring-data.html#cb289-21" aria-hidden="true" tabindex="-1"></a><span class="co"># test on scene 11</span></span>
<span id="cb289-22"><a href="restructuring-data.html#cb289-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-23"><a href="restructuring-data.html#cb289-23" aria-hidden="true" tabindex="-1"></a>unique_pairs(scenes[<span class="dv">11</span>])</span></code></pre></div>
<pre><code>##       char1   char2
## 0  Chandler    Joey
## 1  Chandler  Monica
## 2  Chandler    Paul
## 3  Chandler  Rachel
## 4      Joey  Monica
## 5      Joey    Paul
## 6      Joey  Rachel
## 7    Monica    Paul
## 8    Monica  Rachel
## 9      Paul  Rachel</code></pre>
<p>This looks right. Now we need to apply this to every scene and gather the results into one DataFrame.</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb291-1"><a href="restructuring-data.html#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="co"># start DataFrame</span></span>
<span id="cb291-2"><a href="restructuring-data.html#cb291-2" aria-hidden="true" tabindex="-1"></a>char1 <span class="op">=</span> []</span>
<span id="cb291-3"><a href="restructuring-data.html#cb291-3" aria-hidden="true" tabindex="-1"></a>char2 <span class="op">=</span> []</span>
<span id="cb291-4"><a href="restructuring-data.html#cb291-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-5"><a href="restructuring-data.html#cb291-5" aria-hidden="true" tabindex="-1"></a>edgelist_df <span class="op">=</span> pd.DataFrame({<span class="st">&#39;char1&#39;</span>: char1, <span class="st">&#39;char2&#39;</span>: char2})</span>
<span id="cb291-6"><a href="restructuring-data.html#cb291-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-7"><a href="restructuring-data.html#cb291-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> scene <span class="kw">in</span> scenes:</span>
<span id="cb291-8"><a href="restructuring-data.html#cb291-8" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> unique_pairs(scene)</span>
<span id="cb291-9"><a href="restructuring-data.html#cb291-9" aria-hidden="true" tabindex="-1"></a>  edgelist_df <span class="op">=</span> edgelist_df.append(df, ignore_index <span class="op">=</span> <span class="va">True</span>)</span></code></pre></div>
<p>Now we can order across the rows alphabetically count the occurrences of each unique character pair to get our edge weights:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb292-1"><a href="restructuring-data.html#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort each row alphabetically</span></span>
<span id="cb292-2"><a href="restructuring-data.html#cb292-2" aria-hidden="true" tabindex="-1"></a>edgelist_df <span class="op">=</span> edgelist_df.sort_values(by <span class="op">=</span> [<span class="st">&#39;char1&#39;</span>, <span class="st">&#39;char2&#39;</span>])</span>
<span id="cb292-3"><a href="restructuring-data.html#cb292-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-4"><a href="restructuring-data.html#cb292-4" aria-hidden="true" tabindex="-1"></a><span class="co"># count by unique pair</span></span>
<span id="cb292-5"><a href="restructuring-data.html#cb292-5" aria-hidden="true" tabindex="-1"></a>edgelist <span class="op">=</span> edgelist_df.groupby([<span class="st">&#39;char1&#39;</span>, <span class="st">&#39;char2&#39;</span>]).<span class="op">\</span></span>
<span id="cb292-6"><a href="restructuring-data.html#cb292-6" aria-hidden="true" tabindex="-1"></a><span class="bu">apply</span>(<span class="bu">len</span>).to_frame(<span class="st">&quot;weight&quot;</span>).reset_index()</span>
<span id="cb292-7"><a href="restructuring-data.html#cb292-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-8"><a href="restructuring-data.html#cb292-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb292-9"><a href="restructuring-data.html#cb292-9" aria-hidden="true" tabindex="-1"></a>edgelist.head()</span></code></pre></div>
<pre><code>##       char1     char2  weight
## 0  Chandler  Customer       1
## 1  Chandler      Joey       8
## 2  Chandler    Monica       6
## 3  Chandler      Paul       2
## 4  Chandler    Phoebe       5</code></pre>
<p>This is what we need to create and visualize our graph of Episode 1 of <em>Friends</em>, which can be seen in Figure <a href="restructuring-data.html#fig:friends-graph-py">5.11</a> with the edge thickness determined by edge weight.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb294-1"><a href="restructuring-data.html#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb294-2"><a href="restructuring-data.html#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb294-3"><a href="restructuring-data.html#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="restructuring-data.html#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create networkx object</span></span>
<span id="cb294-5"><a href="restructuring-data.html#cb294-5" aria-hidden="true" tabindex="-1"></a>friends_ep1_network <span class="op">=</span> nx.from_pandas_edgelist(edgelist,</span>
<span id="cb294-6"><a href="restructuring-data.html#cb294-6" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> <span class="st">&quot;char1&quot;</span>, target <span class="op">=</span> <span class="st">&quot;char2&quot;</span>, edge_attr<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb294-7"><a href="restructuring-data.html#cb294-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-8"><a href="restructuring-data.html#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize with edge weight as edge width</span></span>
<span id="cb294-9"><a href="restructuring-data.html#cb294-9" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">123</span>)</span>
<span id="cb294-10"><a href="restructuring-data.html#cb294-10" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> <span class="bu">list</span>(nx.get_edge_attributes(friends_ep1_network, <span class="st">&#39;weight&#39;</span>).values())</span>
<span id="cb294-11"><a href="restructuring-data.html#cb294-11" aria-hidden="true" tabindex="-1"></a>nx.draw_networkx(friends_ep1_network, node_color <span class="op">=</span> <span class="st">&quot;lightblue&quot;</span>, node_size <span class="op">=</span> <span class="dv">60</span>,</span>
<span id="cb294-12"><a href="restructuring-data.html#cb294-12" aria-hidden="true" tabindex="-1"></a>edge_color <span class="op">=</span> <span class="st">&quot;grey&quot;</span>, with_labels <span class="op">=</span> <span class="va">True</span>, width <span class="op">=</span> np.array(weights))</span>
<span id="cb294-13"><a href="restructuring-data.html#cb294-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:friends-graph-py"></span>
<img src="_main_files/figure-html/unnamed-chunk-60-1.png" alt="Graph of Friends character network from Episode 1 with edge width indicating the number of shared scenes" width="672" />
<p class="caption">
Figure 5.11: Graph of Friends character network from Episode 1 with edge width indicating the number of shared scenes
</p>
</div>
</div>
</div>
<div id="learning-exercises-3" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Learning exercises</h2>
<div id="discussion-questions-3" class="section level3" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Discussion questions</h3>
<ol style="list-style-type: decimal">
<li>What kinds of data sources are most likely to already exist in a graph-friendly form? Why?</li>
<li>What are the two most important things to define when you intend to transform data into a graph-friendly structure?</li>
<li>Imagine that you are working in a global Law firm with a database that has three tables. One table lists employee location details including office and home address. A second table includes details on which clients each employee has been working for and what specialty areas they focus on with each client. A third table lists the education history of each employee including school and major/subject area. List out all the different ways you can think to turn this data into a network of employees.</li>
<li>Pick one or two of your answers from Question 2 and write down two options for how to structure a graph for each of them. For one option, consider a graph where employees are the only vertices. Then consider a graph where there are at least two different entities as vertices. How might your edges be defined in each and would they have any properties?</li>
<li></li>
</ol>
</div>
<div id="data-exercises-3" class="section level3" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Data exercises</h3>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="29">
<li id="fn29"><p>The limited cleaning commands here work for this specific episode, but they would need to be expanded to be used on more episodes to take into account any unpredictable formatting in the scripts. The reality of most scraping exercises is that some code has to be written to deal with exceptions.<a href="restructuring-data.html#fnref29" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="viz-graphs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
